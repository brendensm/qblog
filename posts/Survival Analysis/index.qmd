---
title: "Survival Analysis in R"
author: "Brenden Smith"
date: "2022-10-24"
categories: [R, Epi, ggplot2]
description: "Exploring survival analysis with the packages 'survival' and 'survminer.'"
image: thumbnail.png
draft: true
code-fold: show
execute: 
  warning: false
format: 
  html:
    fig-height: 6
    fig-width: 8

---
# Introduction
In this blog post, I'll be exploring some basic survival analysis in R. Survival analysis focuses on describing the occurance of an event (in this example death) in a set timeframe. Survival analysis is often used in clinical research and cancer epidemiology. For more reading, I recommend visiting The Epidemiologist R Handbook page on survival analysis, as well as their listed resources. The following blog post was adapted from my Biostatistics coursework and features data used in that course. We will create a Kaplan-Meier plot and go through Cox Hazard Regression.

# Packages and Data

For this blog post, I will use the packages have, dplyr, survival, ggthemes, and survminer.

```{R}
# Load in libraries
library(haven)
library(dplyr)
library(survival)
library(ggthemes)

```

Next, we will load the data. My professor provided a dataset from SPSS, so we are using haven to load it into R.

```{R}
FHS <- read_sav("data/Cox Prop Hazard Regression Data.sav")
```

To initialize our analysis, we will create a survival object with the function 

```{R}
FHS_surv <- Surv(time = FHS$TimeDeathYears,
                 event = FHS$death)

summary(survfit(FHS_surv ~ 1))
  
```

# Kaplan-Meier Plot

```{R}
plot(FHS_surv, 
     xlab = "Years Since Baseline",    # x-axis label
     ylab ="Survival Probability",   # y-axis label
     main = "Overall survival curve", # figure title
     ylim = c(0, 1),
     mark.time = TRUE,
     conf.int = FALSE
)
```

```{R}
FHS_fit_db <- survfit(Surv(TimeDeathYears, death) ~ diabetes, data = FHS)

col_diabetes <- c("lightblue", "darkblue")

plot(
  FHS_fit_db,
  col = col_diabetes,
  xlab = "Years since baseline",
  ylab = "Survival Probability")
legend(
  "bottomright",
  legend = c("Not diabetic","Diabetic"),
  col = col_diabetes,
  lty = 1,
  cex = .9,
  bty = "n")
```

```{R}

survminer::ggsurvplot(
  FHS_fit_db, 
  data = FHS,          
  conf.int = TRUE,  
  surv.scale = "percent",        # present probabilities in the y axis in %
  break.time.by = 1,            # present the time axis with an increment of years
  xlab = "Time Since baseline (Years)",
  ylab = "Survival Probability",
  pval = T,       # print p-value at these plot coordinates
  risk.table = T,                # print the risk table at bottom 
  legend.title = "Diabetic Status",       # legend characteristics
  legend.labs = c("not diabetic","diabetic"),
  font.legend = 10, 
  palette = "Dark2",             # specify color palette 
  surv.median.line = "hv",       # draw horizontal and vertical lines to the median survivals
  ggtheme = theme_few()
)
```

# Cox Regression and Hazard Ratios



```{R}
FHS_cox <-  coxph(
  Surv(TimeDeathYears, death) ~ diabetes + cursmoke + diabetes + 
    educ + prevchd + age + bmi + sex,
  data = FHS
)

summary(FHS_cox)

FHS_cox_test <- cox.zph(FHS_cox)
FHS_cox_test

survminer::ggforest(FHS_cox, data = FHS)
```
