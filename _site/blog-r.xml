<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0">
  <channel>
    <title>bs</title>
    <link>https://brendenmsmith.com/blog.html#category=R</link>
    <atom:link href="https://brendenmsmith.com/blog-r.xml" rel="self" type="application/rss+xml"/>
    <description/>
    <generator>quarto-1.8.27</generator>
    <lastBuildDate>Mon, 16 Feb 2026 05:00:00 GMT</lastBuildDate>
    <item>
      <title>CDCPLACES 1.2.0</title>
      <link>https://brendenmsmith.com/posts/cdcplaces-1-2-0/</link>
      <description><![CDATA[Place geography, 2025 data, and a major reliability overhaul.]]></description>
      <category>R</category>
      <category>packages</category>
      <category>public-health</category>
      <guid>https://brendenmsmith.com/posts/cdcplaces-1-2-0/</guid>
      <pubDate>Mon, 16 Feb 2026 05:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>I’m happy to announce the release of <a href="https://brendensm.github.io/CDCPLACES/">CDCPLACES</a> 1.2.0. This package lets you query the CDC’s Population Level Analysis and Community Estimates (PLACES) API directly from R, returning health measure estimates for counties, census tracts, ZCTAs, and—new in this release—places (cities, towns, and census-designated places).</p>
<p>You can install it from CRAN with:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"CDCPLACES"</span>)</span></code></pre></div>
<p>Or get the development version from GitHub:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"brendensm/CDCPLACES"</span>)</span></code></pre></div>
<p>This post walks through the highlights. The full changelog is in the <a href="https://brendensm.github.io/CDCPLACES/news/index.html">NEWS file</a>.</p>
<h2 id="place-geography">Place geography</h2>
<p>The biggest addition in 1.2.0 is support for <strong>place-level</strong> data. PLACES has always published estimates for incorporated places and census-designated places, but the package only supported county, tract, and ZCTA queries. Now you can pull place-level data across all release years (2020–2025):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"place"</span>, <span class="at">state =</span> <span class="st">"MI"</span>, <span class="at">measure =</span> <span class="st">"SLEEP"</span>)</span></code></pre></div>
</div>
<p>Place geography also supports the <code>geometry</code> and <code>age_adjust</code> arguments, so you can map city-level estimates just as easily as counties:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"place"</span>, <span class="at">state =</span> <span class="st">"MI"</span>, <span class="at">measure =</span> <span class="st">"SLEEP"</span>, <span class="at">geometry =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<h2 id="release-data">2025 release data</h2>
<p>The package now defaults to the <strong>2025 release year</strong>, which is the latest available from CDC. All four geographies—county, tract, ZCTA, and place—are supported for 2025.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025 is now the default</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"county"</span>, <span class="at">state =</span> <span class="st">"OH"</span>, <span class="at">measure =</span> <span class="st">"ACCESS2"</span>)</span></code></pre></div>
</div>
<p>You can still query any prior year back to 2020 by setting the <code>release</code> argument.</p>
<h2 id="smarter-api-queries">Smarter API queries</h2>
<p>Under the hood, the way queries are built has been rewritten. The package now constructs SQL <code>IN</code> operators instead of chaining <code>LIKE</code>/<code>OR</code> clauses, which produces shorter and more efficient API requests.</p>
<p>More importantly, <strong>ZCTA queries are now automatically batched</strong>. Some states have thousands of ZCTAs (Texas alone has roughly 2,000), and the previous approach could exceed Socrata’s URL length limit and fail silently. The package now detects when a query would be too long and splits it into multiple smaller requests behind the scenes.</p>
<h2 id="breaking-changes">Breaking changes</h2>
<p>A few things to watch for when upgrading:</p>
<ul>
<li><strong><code>geography = "census"</code> has been removed.</strong> Use <code>"tract"</code> instead. The old value now produces a clear error message pointing you to the fix.</li>
<li><strong>The default release year is now <code>"2025"</code>.</strong> If your code relied on the previous default, pass <code>release</code> explicitly to get the same results.</li>
<li><strong>Minimum R version is 4.1.0</strong>, required for the base pipe (<code>|&gt;</code>).</li>
</ul>
<h2 id="reliability-improvements">Reliability improvements</h2>
<p>This release fixes a number of edge-case bugs that could cause confusing errors or silently wrong results:</p>
<ul>
<li><code>geometry = TRUE</code> now uses the correct Census vintage. PLACES switched from 2010 to 2020 Census geographies starting with the 2024 release, so tract and ZCTA GEOIDs could silently fail to join. The package now picks the right shapefiles based on the <code>release</code> year.</li>
<li>County filtering is no longer case-sensitive. Previously, <code>county = "ST. LOUIS"</code> wouldn’t match the API’s title-case <code>"St. Louis"</code>.</li>
<li>Functions that prompt about overlapping counties no longer hang in non-interactive sessions (Shiny, knitr, CI). They now default to including all matches with a message.</li>
<li>Connection-level errors (DNS failures, timeouts) no longer crash with an opaque <code>$ operator is invalid for atomic vectors</code> error.</li>
</ul>
<h2 id="dataset-discovery-is-now-automated">Dataset discovery is now automated</h2>
<p>The internal table of API endpoints used to be maintained by hand. In 1.2.0, <code>data-raw/DATASET.R</code> queries the <a href="https://socratadiscovery.docs.apiary.io/">Socrata Discovery API</a> to programmatically find every PLACES dataset, making it straightforward to add new release years as CDC publishes them.</p>
<p>In addition, the GitHub repo for this package now has a GitHub action to check monthly for URL changes. If for some reason the underlying API URLs change for a specific year or data set, a GitHub issue will automatically be opened.</p>
<h2 id="other-notes">Other notes</h2>
<p>The underlying <a href="https://data.cdc.gov/500-Cities-Places/PLACES-and-500-Cities-Data-Dictionary/m35w-spkz/about_data">data dictionary</a> for the full range of available PLACES data measures and variables has not yet been updated by the PLACES team. This means that there is no additional information included for the 2025 release in this data frame (this is the data frame queried when running <code>get_dictionary</code>).</p>
<p>ZCTA-level data for the 2024 release of PLACES is currently unavailable. This is not posted as a public data set (even though it is present for other release years). I believe this may be due to a mistake during the 2025 release.</p>
<p>For both of these issues, I have contacted PLACES to see if updates will be made. I will update the package and this blog post accordingly.</p>
<h2 id="acknowledgments">Acknowledgments</h2>
<p>I wanted to recognize that many of these updates were made possible by Claude Code. I would like to thank Garrick Aden-Buie from Posit specifically for sharing these <a href="https://github.com/posit-dev/skills">Claude skills</a> which helped immensely in the testing and review of this package update.</p>
<p>If you run into problems or have other ideas, please <a href="https://github.com/brendensm/CDCPLACES/issues">open an issue</a> on GitHub. If you want to stay up to date with me and get notified when I post, consider <a href="https://n1mbmu-brenden-smith.shinyapps.io/listserv/">subscribing to my newsletter.</a></p>]]></content:encoded>
    </item>
    <item>
      <title>Dealing with Windows File Paths in R</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/windows-filepaths/</link>
      <description><![CDATA[A simple function to format complicated file paths.]]></description>
      <category>R</category>
      <guid>https://brendenmsmith.com/posts/windows-filepaths/</guid>
      <pubDate>Thu, 31 Oct 2024 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>Recently, I started a new position that requires me to use a Windows computer (I miss my MacBook Air dearly). This has led me to learn about the subtle differences when using R on different operating systems.</p>
<p>If you are like me, you probably work with a team and handle confidential data. Many workplaces use network drives to store data securely. Often in my day-to-day work, I use files with increasingly complex file paths and read them into RStudio. If you are familiar with this process, you likely know how particular R can be about file path formatting.</p>
<p>R prefers file paths to be separated by forward slashes <code>/</code>. The default file paths in Windows, however, use backward slashes <code>\</code>. You <em>could</em> manually change each backward slash to a forward slash, <em>or</em> add another backward slash so that each folder is separated by two slashes. While both options work most of the time, if you do this often enough, there’s a more efficient solution!</p>
<h2 id="a-function-to-simplify-your-workflow">A Function to Simplify Your Workflow</h2>
<p>To avoid this hassle, I use a custom function to quickly import and format my file paths:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("clipr")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>copied_path <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> clipr<span class="sc">::</span><span class="fu">read_clip</span>() <span class="co"># or readClipboard on Windows</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"^</span><span class="sc">\"</span><span class="st">|</span><span class="sc">\"</span><span class="st">$"</span>, <span class="st">""</span>, out)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\\\</span><span class="st">"</span>, <span class="st">"/"</span>, out)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  clipr<span class="sc">::</span><span class="fu">write_clip</span>(out) <span class="co"># writeClipboard(out)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"The formatted path has been copied to your clipboard."</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<div>
<blockquote>
<p><strong>Note</strong></p>
<p>I am using functions from the R package <code>clipr</code> because I wrote this blog post on a MacBook Air. On a Windows machine, I would use the functions <code>readClipboard</code> and <code>writeClipboard</code> from the <code>utils</code> package to avoid an additional dependency.</p>
</blockquote>
</div>
<p>Let’s say I have a complex file path like this: “my\file\is\in\here\somewhere.txt”. I would first copy this to my clipboard from the file explorer. On a Windows machine, this copies the full path including quotation marks. When we run our function in the console, the following occurs:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">copied_path</span>()</span></code></pre></div>
</details>
</div>
<p><img src="cp_output.jpg"></p>
<p>This returns the neatly formatted file path and automatically copies it to your clipboard, saving you time and effort.</p>
<h2 id="how-the-function-works">How the Function Works</h2>
<p>In R, we can read what is copied to our clipboard. This is the first step in our function. We can call it as a string using the following command:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> clipr<span class="sc">::</span><span class="fu">read_clip</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or readClipboard() on Windows</span></span></code></pre></div>
</details>
</div>
<p>When we copy a file path from the file explorer on a Windows machine, it includes quotation marks. Therefore, the next step is to remove these from the string using regex:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"^</span><span class="sc">\"</span><span class="st">|</span><span class="sc">\"</span><span class="st">$"</span>, <span class="st">""</span>, out)</span></code></pre></div>
</details>
</div>
<p>We can then replace double back slashes with a forward slash. If we don’t do this, the string copied to our clipboard will retain single back slashes:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\\\</span><span class="st">"</span>, <span class="st">"/"</span>, out)</span></code></pre></div>
</details>
</div>
<p>For the final step, we copy the new string to the clipboard, send a message to the console, and return the new string:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  clipr<span class="sc">::</span><span class="fu">write_clip</span>(out) <span class="co"># writeClipboard(out)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"The formatted path has been copied to your clipboard."</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span></code></pre></div>
</details>
</div>
<h2 id="another-alternative">Another Alternative</h2>
<p>If you are using R version 4.0.0 or later, you also have the option of <a href="https://stackoverflow.com/questions/14185287/escaping-backslash-in-string-or-paths-in-r/14185627#14185627">using a raw string constant</a>. This is done by wrapping your text with <code>r"()"</code>. This will return a string with double back slashes:</p>
<p><img src="r.jpg"></p>]]></content:encoded>
    </item>
    <item>
      <title>CDCPLACES 1.1.8: 2024 Release</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/cdcplaces-1-1-8/</link>
      <description><![CDATA[New measures, query ZCTAs, and filter by category.]]></description>
      <category>R</category>
      <category>packages</category>
      <category>maps</category>
      <category>CDCPLACES</category>
      <guid>https://brendenmsmith.com/posts/cdcplaces-1-1-8/</guid>
      <pubDate>Thu, 19 Sep 2024 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p><em>This is part of the <code>CDCPLACES</code> blog series. To view the other posts in this series <a href="https://brendenmsmith.com/blog#category=CDCPLACES">click here.</a></em></p>
<h2 id="introduction">Introduction</h2>
<p>This brief blog post explains the new additions to <code>CDCPLACES</code> 1.1.8. This update provides a few new features:</p>
<ul>
<li><p>Updated 2024 release data, including several new measures under the health-related social needs category</p></li>
<li><p>Two new arguments to help filter your data, <code>cat</code> and <code>age_adjust</code></p></li>
<li><p>The ability to query Zip Code Tabulation Areas (ZCTAs)</p></li>
<li><p>Improved functionality when querying counties with the same name across different states</p></li>
</ul>
<p>In addition to these features, <code>CDCPLACES</code> now depends on <code>yyjsonr</code> instead of <code>jsonlite</code>. Originally, the <code>get_places</code> function included a step to clean the returned <code>geolocation</code> variable (essentially a centroid of the geography queried). This step was removed as it was computationally intensive on larger queries and unncessary given the support for shapefiles with the <code>geometry</code> argument. These changes drastically improve the speed of the package.</p>
<p>To begin, we will load the required packages.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("CDCPLACES")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packges("tidyverse")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CDCPLACES)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
</details>
</div>
<h2 id="new-measures">New Measures</h2>
<p>With the 2024 release of the PLACES data, the default option for the release argument in <code>get_places</code> has been updated to “2024”. You can find all the details of these updated data in the release <a href="https://www.cdc.gov/places/help/data-notes/index.html">notes.</a></p>
<p>An exciting addition to the PLACES data are the new health-related social needs variables. These include: social isolation, food stamps, food insecurity, housing insecurity, utility services threat, transportation barriers, and lack of social and emotional support. These measures are only available in 39 states and the District of Columbia (DC).</p>
<p><img src="screenshots/HRSN.png"></p>
<p>You can view these measures by calling <code>get_dictionary</code>. The category ID for these new measures is “SOCLNEED”.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_dictionary</span>() <span class="sc">|&gt;</span> <span class="fu">filter</span>(categoryid <span class="sc">==</span> <span class="st">"SOCLNEED"</span>) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span></code></pre></div>
</details>
</div>
<h2 id="new-arguments-cat-and-age_adjust">New Arguments: cat and age_adjust</h2>
<p>Some minor quality of life improvements are introduced with the new arguments <code>cat</code> and <code>age_adjust</code>.</p>
<p>We can filter our results to returns a set of measures by category ID.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"county"</span>,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">state =</span> <span class="st">"AL"</span>, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">cat =</span> <span class="st">"SOCLNEED"</span>) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span></code></pre></div>
</details>
</div>
<p>If a measure is provided as well as a category, the category will override it. A message is displayed in the console noting this when it occurs.</p>
<p>To return only the age-adjusted prevalence rates, we can set the argument <code>age_adjust</code> to TRUE. Age-adjusted rates are only available at the county level.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"county"</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">state =</span> <span class="st">"AL"</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">cat =</span> <span class="st">"SOCLNEED"</span>, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">age_adjust =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span></code></pre></div>
</details>
</div>
<h2 id="query-zctas">Query ZCTAs</h2>
<p>A new option has been added to query ZCTAs. To do this, simply set the <code>geography</code> argument equal to “zcta”.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>w_sleep <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"zcta"</span>, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">state =</span> <span class="st">"MI"</span>, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">measure =</span> <span class="st">"SLEEP"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">county =</span> <span class="st">"Barry"</span>, </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">geometry =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</details>
</div>
<p>Like other geographies, we can query shapefiles in the same call and easily plot the output:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>w_sleep <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> data_value, <span class="at">label =</span> locationname)) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_label</span>(<span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"% Sleeping less than 7 hours among adults aged &gt;=18 years"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"In Barry County, Michigan ZCTAs"</span>)</span></code></pre></div>
</details>
</div>
<h2 id="handle-overlapping-counties">Handle Overlapping Counties</h2>
<p>This update provides the ability to query ZCTAs in different states and counties at the same time. This can raise issues when we want to look at counties that have the same name in multiple states.</p>
<p>Consider the following example. If we were interested in looking at dental health access around the Michigan/Ohio border and the Toledo area, we might query Monroe and Lucas Counties. We would set the query up like this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tol <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"zcta"</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">state =</span> <span class="fu">c</span>(<span class="st">"MI"</span>, <span class="st">"OH"</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">measure =</span> <span class="st">"DENTAL"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">county =</span> <span class="fu">c</span>(<span class="st">"LUCAS"</span>, <span class="st">"MONROE"</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geometry =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</details>
</div>
<p>The main issue here is that Ohio also has a Monroe County. <code>CDCPLACES</code> will automatically check to see if your returned data contains these overlaps. You will see output in the console that looks like this:</p>
<p><img src="screenshots/terminal1.jpg"></p>
<p>The package will prompt you if you want to include these overlaps. After asking this, it will ask you to specify the counties you wish to exclude from your returned data:</p>
<p><img src="screenshots/terminal2.jpg"></p>
<p>If you choose not to make any exclusions you will get the full data with overlaps. In this example, I excluded Ohio’s Monroe County because it is far from the area of interest.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>We can now plot our returned data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>tol <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> data_value)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_viridis_c</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Visited a dentist or dental clinic in the past year among adults aged &gt;=18 years"</span>, </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="st">"In Monroe County, Michigan and Lucas County, Ohio ZCTAs"</span>)</span></code></pre></div>
</details>
</div>
<p><img src="screenshots/tol2.png"></p>

<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">]]></content:encoded>
    </item>
    <item>
      <title>Interactive Map Filter in Shiny</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/shiny-map-filter/</link>
      <description><![CDATA[Create a clickable map filter similar to PowerBI]]></description>
      <category>R</category>
      <category>maps</category>
      <guid>https://brendenmsmith.com/posts/shiny-map-filter/</guid>
      <pubDate>Wed, 26 Jun 2024 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Recently, I participated in <a href="https://posit.co/blog/announcing-the-2024-table-contest/">Posit’s 2024 Table Contest</a>. For my submission, <a href="https://forum.posit.co/t/michigan-substance-use-vulnerability-index-mi-suvi-exploration-table-table-contest/188198">which you can view here</a>, I included a leaflet map that acts as a filter in Shiny. This is a cool, dashboard-like feature similar to what you might find in Power BI. I recreated this effect and learned a bit through the process.</p>
<p>I first saw this wonderful <a href="https://www.natedayta.com/2019/05/05/an-inputmap-for-your-shiny-app/">blog post by Nathan Day</a> but realized didn’t exactly match the feel I was going for. I adapted his code and added my own preferences (specifically allowing the input map to select multiple polygons and resetting the output table when polygons were “unclicked”). I wanted to share a basic example for others who might want to try this out!</p>
<p><img src="images/demo.gif"></p>
<h2 id="example-data">Example Data</h2>
<p>The data I will be using for this example can be queried using the <code>CDCPLACES</code> package (<a href="https://github.com/brendensm/CDCPLACES">see more on GitHub</a>). I will take a sample of county data from the State of Ohio. Here I am filtering only the age-adjusted rates and the measure “ACCESS2” which is the percentage of the population aged 18-64 that lack health insurance. I will also set the CRS for the data using <code>sf::st_transform</code> to avoid warnings when the data is queried.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CDCPLACES)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>ohio <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">state =</span> <span class="st">"OH"</span>, <span class="at">measure =</span> <span class="st">"ACCESS2"</span>, <span class="at">geometry =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datavaluetypeid <span class="sc">==</span> <span class="st">"AgeAdjPrv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, stateabbr, locationname, measure, data_value, geometry) <span class="sc">|&gt;</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span></code></pre></div>
</details>
</div>
<h2 id="ui">UI</h2>
<p>Next, we can get into the UI side of our demo app. This is fairly straightforward. We initiate a fluid page, a title, and a sidebar layout. The sidebar has our leaflet map as a filter. In the main panel, we will output a data table.</p>
<p>I have added a <code>tags$head</code> function to add some custom CSS to the app. This is an optional step, but these two options make the panel transparent, which I think adds a lot to the look and feel of the app.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">head</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="sc">$</span><span class="fu">style</span>(<span class="fu">HTML</span>(<span class="st">".leaflet-container { background: none; } </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="st">                    .well { background: none;}"</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">"My Demo App"</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sidebarLayout</span>(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sidebarPanel</span>(</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">leafletOutput</span>(<span class="st">"mapfilter"</span>, <span class="at">height =</span> <span class="dv">250</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mainPanel</span>(</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>           DT<span class="sc">::</span><span class="fu">DTOutput</span>(<span class="st">"table"</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</details>
</div>
<h2 id="server">Server</h2>
<p>Now we can specify the logic of the server to get the result we want. To start we can initialize a few reactive values. This will allow us to update our filtered data and what is displayed on the map. <code>selected_counties</code> will correspond to what is highlighted on the map when we click, <code>filtered_data</code> will be the data frame that is displayed on the main table output.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Initialize reactive values</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>     rv <span class="ot">&lt;-</span> <span class="fu">reactiveValues</span>(<span class="at">selected_counties =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">filtered_data =</span> ohio) <span class="co"># Initialize reactive values</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<div>
<blockquote>
<p><strong>Note</strong></p>
<p>The following code chunks are wrapped within the <code>server</code> function call.</p>
</blockquote>
</div>
<h3 id="outputs">Outputs</h3>
<p>This section will briefly describe the functions for our outputs: the map filter and the table.</p>
<h4 id="table">Table</h4>
<p>This chunk defines the output corresponding to the id <code>table</code>, and renders a datatable. We input the reactive value of our filtered data with <code>rv$filtered_data</code>, remove the geometry with <code>sf::st_set_geometry(NULL)</code>, and send it to <code>DT::datatable()</code> for a simple table display.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>table <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">renderDT</span>({</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>      rv<span class="sc">$</span>filtered_data <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        DT<span class="sc">::</span><span class="fu">datatable</span>()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    })</span></code></pre></div>
</details>
</div>
<h4 id="map">Map</h4>
<p>For our map, we follow similar steps. We use the base data frame <code>ohio</code> to create our map. Future steps will show how we update this with our click behavior. <code>highlightOptions</code> here defines how the map reacts to hovering over polygons. It will fill the county the mouse is hovering over.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>mapfilter <span class="ot">&lt;-</span> <span class="fu">renderLeaflet</span>({ <span class="co"># rendering the filter map</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">leaflet</span>(ohio, <span class="co"># initializing the map</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">options =</span> <span class="fu">leafletOptions</span>( </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">zoomControl =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">dragging =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">minZoom =</span> <span class="dv">6</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">maxZoom =</span> <span class="dv">6</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            )) <span class="sc">|&gt;</span>  <span class="co"># then add polygons</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addPolygons</span>(<span class="at">layerId =</span> <span class="sc">~</span>locationname,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">label =</span> <span class="sc">~</span>locationname,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fillColor =</span> <span class="st">"steelblue"</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fillOpacity =</span> .<span class="dv">1</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">highlight =</span> <span class="fu">highlightOptions</span>(</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillOpacity =</span> <span class="dv">1</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">bringToFront =</span> <span class="cn">TRUE</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                  ))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  })</span></code></pre></div>
</details>
</div>
<h3 id="click-behavior">Click Behavior</h3>
<p>Next, we will define our behavior when the map is clicked. We can break this into two parts, updating the data that is fed into the output table, and changing the display of the input map.</p>
<p>The code chunk below runs when a polygon on our map is clicked. That is the logic of the <code>observeEvent</code> function and its argument <code>input$mapfilter_shape_click</code>. Because our actions all relate to this event, we can wrap all of our code in it. The other step here is to store the input in an object called <code>click</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>mapfilter_shape_click, { </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this is the logic behind the "click" of the map.</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        click <span class="ot">&lt;-</span> input<span class="sc">$</span>mapfilter_shape_click</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  })</span></code></pre></div>
</details>
</div>
<p>If we were to simply <code>print(click)</code> we would see the following output upon an initial click and a second click of the same polygon:</p>
<div class="panel-tabset">
<ul id="tabset-1" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-1-1">Initial Click</a></li><li><a href="#tabset-1-2">Second Click</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1">
<p><img src="images/firstclick.jpg" height="250"></p>
</div>
<div id="tabset-1-2">
<p><img src="images/selected.jpg" height="250"></p>
</div>
</div>
</div>
<p>This will inform how we use the input to update our data and map.</p>
<p>We can use a set of <code>if</code> and <code>else</code> statements to store data from click in our reactive values.</p>
<ul>
<li><p>The first statement checks to see if the current <code>click$id</code> exists in <code>rv$selected_counties</code>. If it does, it will remove it from the vector.</p></li>
<li><p>The next statement checks to see if the <code>click$id</code> is equal to “selected”. Recall that this occurs when the same polygon is selected twice in a row. If this condition is met, we will filter <code>rv$selected_counties</code> by removing the last value in the length of the vector.</p></li>
<li><p>Lastly, if the other two conditions are not met, the new and unique <code>click$id</code> is added to <code>rv$selected_counties</code>.</p></li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (click<span class="sc">$</span>id <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If selected, remove it</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>          rv<span class="sc">$</span>selected_counties[rv<span class="sc">$</span>selected_counties <span class="sc">!=</span> click<span class="sc">$</span>id]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(click<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"selected"</span>){ </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># when a county is clicked again it is removed</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>          rv<span class="sc">$</span>selected_counties[rv<span class="sc">$</span>selected_counties <span class="sc">!=</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">tail</span>(rv<span class="sc">$</span>selected_counties, <span class="at">n =</span> <span class="dv">1</span>)]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span> { <span class="co"># If not selected, add it</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> <span class="fu">c</span>(rv<span class="sc">$</span>selected_counties, click<span class="sc">$</span>id)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      }</span></code></pre></div>
</details>
</div>
<p>Then we have an update to our map. We can accomplish this with <code>leafletProxy</code>. We will simply add an <code>ifelse</code> function to the argument <code>fillOpacity</code>. This ensures that counties present in our <code>rv$selected_counties</code> will have the proper fill.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>      <span class="fu">leafletProxy</span>(<span class="st">"mapfilter"</span>, session) <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addPolygons</span>(<span class="at">data =</span> ohio,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">layerId =</span> <span class="sc">~</span>locationname,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label =</span> <span class="sc">~</span>locationname,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillColor =</span> <span class="st">"steelblue"</span>, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillOpacity =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                      ohio<span class="sc">$</span>locationname <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties, <span class="dv">1</span>, <span class="fl">0.1</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                      ),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">highlight =</span> <span class="fu">highlightOptions</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fillOpacity =</span> <span class="dv">1</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">bringToFront =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                    )</span></code></pre></div>
</details>
</div>
<p>Each of these pieces all fit into our <code>observeEvent</code> function for a click on the map, so in our consolidated code it will look like this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>mapfilter_shape_click, { </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    click <span class="ot">&lt;-</span> input<span class="sc">$</span>mapfilter_shape_click</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (click<span class="sc">$</span>id <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties) {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>          rv<span class="sc">$</span>selected_counties[rv<span class="sc">$</span>selected_counties <span class="sc">!=</span> click<span class="sc">$</span>id]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(click<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"selected"</span>){ </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>          rv<span class="sc">$</span>selected_counties[rv<span class="sc">$</span>selected_counties <span class="sc">!=</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">tail</span>(rv<span class="sc">$</span>selected_counties, <span class="at">n =</span> <span class="dv">1</span>)]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span> {</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> <span class="fu">c</span>(rv<span class="sc">$</span>selected_counties, click<span class="sc">$</span>id)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">leafletProxy</span>(<span class="st">"mapfilter"</span>, session) <span class="sc">|&gt;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addPolygons</span>(<span class="at">data =</span> ohio,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">layerId =</span> <span class="sc">~</span>locationname,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label =</span> <span class="sc">~</span>locationname,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillColor =</span> <span class="st">"steelblue"</span>, </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillOpacity =</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                      ohio<span class="sc">$</span>locationname <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties, <span class="dv">1</span>, <span class="fl">0.1</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                      ),</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                    <span class="at">highlight =</span> <span class="fu">highlightOptions</span>(</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fillOpacity =</span> <span class="dv">1</span>,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">bringToFront =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  })</span></code></pre></div>
</details>
</div>
<p>Lastly, we have one more <code>if else</code> statement in our server. The following code chunk takes the reactive value <code>rv$selected_counties</code> and updates <code>rv$filtered_data</code> which we use to render the table. This logic will cause the data to reset when we have no selected counties (all the shapes are “unclicked”).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observe</span>({ <span class="co"># Update table filtering based on selected counties</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(rv<span class="sc">$</span>selected_counties) <span class="sc">&amp;&amp;</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">length</span>(rv<span class="sc">$</span>selected_counties) <span class="sc">&gt;</span> <span class="dv">0</span>) { </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if any counties are selected</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>filtered_data <span class="ot">&lt;-</span> ohio <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">filter</span>(locationname <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>filtered_data <span class="ot">&lt;-</span> ohio</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    })</span></code></pre></div>
</details>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>This post was an excellent way for me to revisit my code and share an interesting and unique Shiny feature. In this process I ended up eliminating quite a few redundancies in my original code and reinforced some of the concepts of reactivity showcased here.</p>
<p>I hope you find this tutorial useful. If you put it to use, please share it with me! I would love to see the work you come up with.</p>
<p>See the full consolidated example code below.</p>
<h2 id="full-code">Full Code</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CDCPLACES)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmltools)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>ohio <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">state =</span> <span class="st">"OH"</span>, <span class="at">measure =</span> <span class="st">"ACCESS2"</span>, <span class="at">geometry =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datavaluetypeid <span class="sc">==</span> <span class="st">"AgeAdjPrv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, stateabbr, locationname, measure, data_value, geometry) <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">head</span>(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    tags<span class="sc">$</span><span class="fu">style</span>(<span class="fu">HTML</span>(<span class="st">".leaflet-container { background: none; } .well { background: none;}"</span>))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Application title</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">"My Demo App"</span>),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sidebar with a slider input for number of bins</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sidebarLayout</span>(</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sidebarPanel</span>(</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">leafletOutput</span>(<span class="st">"mapfilter"</span>, <span class="at">height =</span> <span class="dv">250</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show a plot of the generated distribution</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mainPanel</span>(</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>           DT<span class="sc">::</span><span class="fu">DTOutput</span>(<span class="st">"table"</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Define server logic required to draw a histogram</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>   rv <span class="ot">&lt;-</span> <span class="fu">reactiveValues</span>(<span class="at">selected_counties =</span> <span class="cn">NULL</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                        <span class="at">filtered_data =</span> ohio) <span class="co"># Initialize reactive value for selected counties</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>mapfilter_shape_click, { <span class="co"># this is the logic behind the "click" of the map.</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    click <span class="ot">&lt;-</span> input<span class="sc">$</span>mapfilter_shape_click</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="do">########## map behavior ################</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If a county is clicked</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (click<span class="sc">$</span>id <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties) {</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If selected, remove it</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> rv<span class="sc">$</span>selected_counties[rv<span class="sc">$</span>selected_counties <span class="sc">!=</span> click<span class="sc">$</span>id]</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(click<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"selected"</span>){ <span class="co"># when a county is clicked again it is removed</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> rv<span class="sc">$</span>selected_counties[rv<span class="sc">$</span>selected_counties <span class="sc">!=</span> <span class="fu">tail</span>(rv<span class="sc">$</span>selected_counties, <span class="at">n =</span> <span class="dv">1</span>)]</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>      }<span class="cf">else</span> {</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If not selected, add it</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>selected_counties <span class="ot">&lt;-</span> <span class="fu">c</span>(rv<span class="sc">$</span>selected_counties, click<span class="sc">$</span>id)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">leafletProxy</span>(<span class="st">"mapfilter"</span>, session) <span class="sc">|&gt;</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addPolygons</span>(<span class="at">data =</span> ohio,</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>                    <span class="at">layerId =</span> <span class="sc">~</span>locationname,</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label =</span> <span class="sc">~</span>locationname,</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillColor =</span> <span class="st">"steelblue"</span>, <span class="co"># Change fill color based on selection</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>                    <span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>                    <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillOpacity =</span> <span class="fu">ifelse</span>(ohio<span class="sc">$</span>locationname <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties, <span class="dv">1</span>, <span class="fl">0.1</span>),</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>                    <span class="at">highlight =</span> <span class="fu">highlightOptions</span>(</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fillOpacity =</span> <span class="dv">1</span>,</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                      <span class="at">bringToFront =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>mapfilter <span class="ot">&lt;-</span> <span class="fu">renderLeaflet</span>({ <span class="co"># rendering the filter map</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">leaflet</span>(ohio,</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>            <span class="at">options =</span> <span class="fu">leafletOptions</span>( <span class="co"># initializing the map</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>              <span class="at">zoomControl =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>              <span class="at">dragging =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>              <span class="at">minZoom =</span> <span class="dv">6</span>,</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>              <span class="at">maxZoom =</span> <span class="dv">6</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>            )) <span class="sc">%&gt;%</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addPolygons</span>(<span class="at">layerId =</span> <span class="sc">~</span>locationname,</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>                  <span class="at">label =</span> <span class="sc">~</span>locationname,</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>                  <span class="co">#   fillColor = "black",</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fillColor =</span> <span class="st">"steelblue"</span>,</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>                  <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fillOpacity =</span> .<span class="dv">1</span>,</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>                  <span class="at">highlight =</span> <span class="fu">highlightOptions</span>(</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fillOpacity =</span> <span class="dv">1</span>,</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>                    <span class="at">bringToFront =</span> <span class="cn">TRUE</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>                  ))</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>table <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">renderDT</span>({</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>      rv<span class="sc">$</span>filtered_data <span class="sc">|&gt;</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>        DT<span class="sc">::</span><span class="fu">datatable</span>()</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observe</span>({ <span class="co"># Update table filtering based on selected counties</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(rv<span class="sc">$</span>selected_counties) <span class="sc">&amp;</span> <span class="fu">length</span>(rv<span class="sc">$</span>selected_counties) <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co"># Check if any counties are selected</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>filtered_data <span class="ot">&lt;-</span> ohio <span class="sc">|&gt;</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">filter</span>(locationname <span class="sc">%in%</span> rv<span class="sc">$</span>selected_counties)</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>        rv<span class="sc">$</span>filtered_data <span class="ot">&lt;-</span> ohio</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the application</span></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(<span class="at">ui =</span> ui, <span class="at">server =</span> server)</span></code></pre></div>
</details>
</div>]]></content:encoded>
    </item>
    <item>
      <title>I Made R Text For Me</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/r-text-messages/</link>
      <description><![CDATA[Do you ever wish that text message would just send itself?]]></description>
      <category>R</category>
      <category>Command line</category>
      <guid>https://brendenmsmith.com/posts/r-text-messages/</guid>
      <pubDate>Sat, 23 Mar 2024 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Up front, I have problems with procrastination. The last few years in graduate school have made me prioritize certain things MUCH better. However, in my personal life, I still struggle. I continue to put off things that I would rather do later. A prime example of this is my role as utility-bill-payer in my current living situation.</p>
<p>It is my duty to pay our house’s gas, internet, trash, and electric/water bills every month. I am reliable enough for this (especially with the convenience of automatic payments). My struggle is the monthly task of rounding up these payments, calculating the totals owed by my respective roommates, and the herculean task of texting them the breakdown for the month. Lately, I have been contemplating fun, useful projects to work on using the beauty of programming languages and I realized this is the perfect thing to do.</p>
<p>The plan? Make this process as easy as possible for me. With a little trial and error, I’ve done it.</p>
<p>This project consists of:</p>
<ul>
<li><p>A spreadsheet to store the monthly breakdown of utility payments (unfortunately, this still has to be done by hand).</p></li>
<li><p>An R script to pull this spreadsheet in and send a custom text message that uses the most recent month’s total and roommate share amount (along with a breakdown of each bill amount).</p></li>
<li><p>A method to automatically run this process without any reliability on my behalf (insert cron jobs).</p></li>
</ul>
<h2 id="the-spreadsheet">The Spreadsheet</h2>
<p>This was a task I already had mostly completed. At the beginning of this year, I created a very basic spreadsheet in Google Sheets to track my utility bills. One table consists of the data in a tidy format, including columns for the month, bill type, amount, and date paid. A second table creates a sum from the first table giving the date to notify (the first of the month after the month in which the bill was paid), the total amount, and the amount owed by the roommate (one-third split on the total).</p>
<p>Because each bill comes from a different place and my email isn’t easily accessible to a programming language, I still have to update this spreadsheet by hand whenever I am notified of a payment. And for my purposes, I was ok with this!</p>
<h2 id="r-script">R Script</h2>
<p>The script for this project has three main tasks:</p>
<ol type="1">
<li><p>Import the data from Google Sheets.</p></li>
<li><p>Create the text of the message.</p></li>
<li><p>Send the text message.</p></li>
</ol>
<h3 id="getting-the-data">Getting the Data</h3>
<p>First, we can call the libraries we will need.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(googlesheets4)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
</details>
</div>
<p>The package <code>googlesheets4</code> made this project incredibly easy.</p>
<p>You can connect to your Google account using <code>gs4_auth</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gs4_auth</span>(<span class="at">email =</span> <span class="st">"your email here"</span>)</span></code></pre></div>
</details>
</div>
<p>Then, you can import your sheet.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_sheet</span>(<span class="st">"your_url_here"</span>)</span></code></pre></div>
</details>
</div>
<p>To demonstrate what my data looked like, I will create a demo data set to work with in this example.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>month <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Feb"</span>, <span class="st">"Feb"</span>, <span class="st">"Feb"</span>, <span class="st">"Mar"</span>, <span class="st">"Mar"</span>, <span class="st">"Mar"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>bill_type <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Gas"</span>, <span class="st">"Water"</span>, <span class="st">"Internet"</span>, <span class="st">"Gas"</span>, <span class="st">"Water"</span>, <span class="st">"Internet"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>amount <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">62</span>, <span class="dv">25</span>, <span class="dv">55</span>, <span class="dv">70</span>, <span class="dv">25</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>due_date <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2/1/2024"</span>, <span class="st">"2/4/2024"</span>, <span class="st">"2/5/2024"</span>, </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"3/1/2024"</span>, <span class="st">"3/5/2024"</span>, <span class="st">"3/6/2024"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(month, bill_type, amount, due_date) <span class="sc">|&gt;</span> </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">due_date =</span> lubridate<span class="sc">::</span><span class="fu">mdy</span>(due_date))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>table1</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>table2<span class="fl">.1</span><span class="ot">&lt;-</span> table1 <span class="sc">|&gt;</span> </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> month,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">total =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">third =</span> total<span class="sc">/</span><span class="dv">3</span>) </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>notify <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"3/1/2024"</span>, <span class="st">"4/1/2024"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>table2<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(notify) <span class="sc">|&gt;</span> </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">notify =</span> lubridate<span class="sc">::</span><span class="fu">mdy</span>(notify))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(table2<span class="fl">.1</span>, table2<span class="fl">.2</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>table2</span></code></pre></div>
</details>
</div>
<h3 id="creating-the-message">Creating the Message</h3>
<p>Because my real data has all of the month’s data in it, we need to filter to get the right amounts to send in our text. We can use <code>Sys.Date</code> to get the current date, and <code>lubridate::month</code> to make the date a numeric value representing the month.</p>
<p>Then we can do the same for our tables to filter by. Remember I will have this script executing at the first of every month to report what the costs were for the previous month.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># current_month &lt;- lubridate::month(Sys.Date())</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>current_month <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># for our example</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>filtered_sum <span class="ot">&lt;-</span> table2 <span class="sc">|&gt;</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">notify =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(notify)) <span class="sc">|&gt;</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(notify <span class="sc">==</span> current_month)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>monthly_total <span class="ot">&lt;-</span> filtered_sum<span class="sc">$</span>total</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>third <span class="ot">&lt;-</span> filtered_sum<span class="sc">$</span>third</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>breakdown <span class="ot">&lt;-</span> table1 <span class="sc">|&gt;</span> </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month_num =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(due_date)) </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>breakdown_amounts <span class="ot">&lt;-</span> breakdown <span class="sc">|&gt;</span> </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(month_num <span class="sc">==</span> (current_month <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(bill_type, amount)</span></code></pre></div>
</details>
</div>
<p>Now that we have the amounts we need, we can construct a message.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a> message <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"The total of our utility bill for the month of"</span>, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                  filtered_sum<span class="sc">$</span>month, <span class="st">"is:"</span>, monthly_total, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"</span><span class="sc">\n</span><span class="st">A third of this total is:"</span>, <span class="fu">round</span>(third, <span class="dv">2</span>), </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"</span><span class="sc">\n\n</span><span class="st">Here is a breakdown of the bill:"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, breakdown_amounts[<span class="dv">1</span>,<span class="dv">1</span>], <span class="st">": "</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                     breakdown_amounts[<span class="dv">1</span>,<span class="dv">2</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                     breakdown_amounts[<span class="dv">2</span>,<span class="dv">1</span>], <span class="st">": "</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                     breakdown_amounts[<span class="dv">2</span>,<span class="dv">2</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                     breakdown_amounts[<span class="dv">3</span>,<span class="dv">1</span>], <span class="st">": "</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                     breakdown_amounts[<span class="dv">3</span>,<span class="dv">2</span>]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(message)</span></code></pre></div>
</details>
</div>
<h3 id="sending-the-message">Sending the Message</h3>
<p>Next, we text.</p>
<p>The method I am using is <strong>only for iMessage devices,</strong> and is really only possible from a Mac. This method is taken from a very helpful <a href="https://stackoverflow.com/questions/6543070/send-a-text-message-from-r">Stackoverflow post.</a> There is probably a workaround for other devices and sending through SMS, but that is not the focus of this post.</p>
<p>We can send our text with an Apple Script. Here is a function to do just that. This is slightly adapted from the Stackoverflow answer and allows for separate texts to multiple recipients.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>send_text <span class="ot">&lt;-</span> <span class="cf">function</span>(message, buddy){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> buddy){</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">'osascript -e </span><span class="sc">\'</span><span class="st">tell application "Messages"</span><span class="sc">\'</span><span class="st"> -e </span><span class="sc">\'</span><span class="st">send "'</span>, message, <span class="st">'" to buddy'</span>, i,  <span class="st">'of (service 1 whose service type is iMessage)</span><span class="sc">\'</span><span class="st"> -e </span><span class="sc">\'</span><span class="st">end tell</span><span class="sc">\'</span><span class="st">'</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<p>Then we can simply plug in the rest. But be warned: running this command will send a text! Be careful when testing this out.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>buddies <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"</span><span class="sc">\"</span><span class="st">phonenumber1</span><span class="sc">\"</span><span class="st">"</span>, <span class="st">"</span><span class="sc">\"</span><span class="st">phonenumber2</span><span class="sc">\"</span><span class="st">"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">send_text</span>(message, buddies)</span></code></pre></div>
</details>
</div>
<h2 id="the-cron-job">The Cron Job</h2>
<p>Now that the hard part is over, we can simply create a cron job to run this script directly from the command line on the first of every month.</p>
<p><strong>Important: make sure the following is at the top of your saved R script:</strong></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/local/bin/Rscript</span></span></code></pre></div>
</details>
</div>
<p>To open your cron tab, in the terminal type the following command:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">VISUAL</span><span class="op">=</span>nano<span class="kw">;</span> <span class="fu">crontab</span> <span class="at">-e</span></span></code></pre></div>
</details>
</div>
<p>As an added tip, you can save this command as an alias in your .zshrc file to make it easier to quickly access.</p>
<p>Once the cron tab is open, you have to set up the job and specify how often you want it to run. The following runs on the first of every month at 9 AM. The command navigates to my home directory, and then executes my R script which I have named “utes_notif.R”.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> 9 1 <span class="pp">*</span> <span class="pp">*</span> cd ~<span class="kw">;</span> <span class="ex">./Desktop/R/utility_notification/utes_notif.R</span></span></code></pre></div>
</details>
</div>
<h2 id="other-considerations">Other Considerations</h2>
<p>Lastly, I want to note a small consideration when setting up an automated process like this. The cron job will run in this form only if the computer is awake during the scheduled time.</p>
<p>To work around this, you can utilize the battery options in your Mac’s system preferences. I have scheduled my computer to wake up every day at 9 AM for about five minutes. This was the easiest work around for me. However, I am certain there are other options to achieve the same goal. One option may be to use alternative scheduling tools like cronwake or anacron.</p>]]></content:encoded>
    </item>
    <item>
      <title>What’s New in CDCPLACES 1.1.5</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/cdcplaces-1-1-5/</link>
      <description><![CDATA[Map PLACES data easily with the help of tigris.]]></description>
      <category>R</category>
      <category>packages</category>
      <category>API</category>
      <category>vignette</category>
      <category>maps</category>
      <category>CDCPLACES</category>
      <guid>https://brendenmsmith.com/posts/cdcplaces-1-1-5/</guid>
      <pubDate>Tue, 19 Mar 2024 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p><em>This is part of the <code>CDCPLACES</code> blog series. To view the other posts in this series <a href="https://brendenmsmith.com/blog#category=CDCPLACES">click here.</a></em></p>
<p><em>An earlier version of this blog post was published on February 6, 2024 and described the new features in the development version of this package. This update shows all of the new features of the package as of March 16, 2024.</em></p>
<h2 id="introduction">Introduction</h2>
<p><code>CDCPLACES</code> version 1.1.5 is now available on CRAN. Users can now request an sf data frame to allow for simple, streamlined mapping of PLACES data. To use this new feature, be sure to install the latest version from CRAN or GitHub.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install the latest development version</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("brendensm/CDCPLACES")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Or from CRAN</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("CDCPLACES")</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CDCPLACES)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
</details>
</div>
<h2 id="new-argument-geometry">New argument <code>geometry</code></h2>
<p>First we need to query our data. To include our shape file, we need to specify the argument <code>geometry</code> as “TRUE”. For our first example we will look at the percentage of adults sleeping less than 7 hours in Michigan Counties.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mi <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">state =</span> <span class="st">"MI"</span>, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">measure =</span> <span class="st">"SLEEP"</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">geometry =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</details>
</div>
<p>Now we can take this dataset and immediately plot the spatial data with <code>ggplot2</code>. I will also add a nicer looking color palette and the percentage scale in <code>scale_fill_viridis_c</code>, as well as a title with the function <code>labs</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mi <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datavaluetypeid <span class="sc">==</span> <span class="st">"AgeAdjPrv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> data_value)) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> mi<span class="sc">$</span>measure) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title.position =</span> <span class="st">"plot"</span>)</span></code></pre></div>
</details>
</div>
<p>We can do the same for census level data. This is as simple as specifying our geography to “census”.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>vt <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"census"</span>, </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">state =</span> <span class="st">"VT"</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">measure =</span> <span class="st">"SLEEP"</span>, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">geometry =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</details>
</div>
<p>Then we can map it just the same.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>vt <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> data_value)) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> vt<span class="sc">$</span>measure) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title.position =</span> <span class="st">"plot"</span>)</span></code></pre></div>
</details>
</div>
<h2 id="query-by-county">Query by County</h2>
<p>This update also allows for the user to query specific counties using the argument <code>county</code>. In the example below, we can specify the state and counties we want to plot with simple syntax.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cap_county <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"census"</span>, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">state =</span> <span class="st">"MI"</span>, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">measure =</span> <span class="st">"ACCESS2"</span>, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">county =</span> <span class="fu">c</span>(<span class="st">"Ingham"</span>, <span class="st">"Eaton"</span>, <span class="st">"Clinton"</span>), </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">geometry =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</details>
</div>
<p>Once this is done, we can plot our data.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cap_county <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> data_value)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> cap_county<span class="sc">$</span>measure) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title.position =</span> <span class="st">"plot"</span>)</span></code></pre></div>
</details>
</div>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>These features would not be possible without the excellent work of Kyle Walker’s package <code>tigris</code>. The contributions he has made to the R community have been incredibly inspiring to me. His other package, <code>tidycensus</code> was the inspiration for this entire pacakge. To see his work visit his website <a href="https://walker-data.com/">here.</a></p>]]></content:encoded>
    </item>
    <item>
      <title>Introducing the CDCPLACES Package</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/intro-cdcplaces/</link>
      <description><![CDATA[A brief vignette demonstrating the use of the package CDCPLACES.]]></description>
      <category>R</category>
      <category>packages</category>
      <category>API</category>
      <category>vignette</category>
      <category>CDCPLACES</category>
      <guid>https://brendenmsmith.com/posts/intro-cdcplaces/</guid>
      <pubDate>Wed, 10 Jan 2024 05:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p><em>This is part of the <code>CDCPLACES</code> blog series. To view the other posts in this series <a href="https://brendenmsmith.com/blog#category=CDCPLACES">click here.</a></em></p>
<p><em>This post was updated on March 19, 2024 to reflect updates introduced in CDCPLACES 1.1.5.</em></p>
<h2 id="introduction">Introduction</h2>
<p>To begin, we can install from CRAN, or from github, then load our packages.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install from CRAN</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("CDCPLACES)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Install from Github</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("brendensm/CDCPLACES")</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CDCPLACES)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
</details>
</div>
<h2 id="function-get_dictionary">Function: <code>get_dictionary</code></h2>
<p>Our first functions allows us to easily view what measures we can query, via ‘measureid’, along with a brief definition of each function. If we run <code>get_dictionary</code>, a data frame is returned. We can view the measures in a data frame in the R Studio with <code>View()</code>. This is the preferred method for exploring the available measures.</p>
<p>For our example here, I will print the names of the variables in this dataframe.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To open a viewer</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># get_dictionary() %&gt;% View()</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">get_dictionary</span>() <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
</details>
</div>
<p>This data frame is useful for several reasons. It lists the available measures for each year of the CDC PLACES data, along with the data each variable was collected, all in a single place. Remember to use the <code>measureid</code> when querying your data.</p>
<h2 id="function-get_places">Function: <code>get_places</code></h2>
<p>This function allows us to easily query data that we specify. In the example below, I will get the measure <code>ACCESS2</code> (the current lack of health insurance among adults aged 18-64 years) for the state of Arizona. This function allows for multiple of these arguments.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>az_access <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">state =</span> <span class="st">"AZ"</span>, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">measure =</span> <span class="st">"ACCESS2"</span>) </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(az_access)</span></code></pre></div>
</details>
</div>
<p>It is also worth noting that by default <code>geography</code> specifying geography is set to “county”. If instead we want to examine census tracts, we could specify the argument. Likewise, <code>release</code> is set to “2023” by default.</p>
<p>The argument <code>county</code> can be used to filter results to specific counties. This is extremely useful for examining census level data for specific areas of states. Additionally, <code>geometry</code> can be added to include a shapefile in the query. For further examples of plotting with shapefiles, see this <a href="https://brendenmsmith.com/posts/shapefiles%20in%20cdcplaces/">dedicated blog post.</a></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cap_counties <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">geography =</span> <span class="st">"census"</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">state =</span> <span class="st">"MI"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">measure =</span> <span class="st">"ACCESS2"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">county =</span> <span class="fu">c</span>(<span class="st">"Ingham"</span>, <span class="st">"Eaton"</span>, <span class="st">"Clinton"</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">geometry =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</details>
</div>
<h2 id="use-case">Use Case</h2>
<p>From here, we can start to have fun. It is fairly straight forward to begin exploring data. Here I will first filter out the data so that I can plot the age adjusted rates of lack of health insurance in Arizona.</p>
<p>Notice that the data provide you with confidence limits, so I have chosen to plot them here with error bars.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>az_access <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datavaluetypeid <span class="sc">==</span> <span class="st">"AgeAdjPrv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(data_value, <span class="fu">reorder</span>(locationname, data_value))) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> low_confidence_limit, <span class="at">xmax =</span> high_confidence_limit)) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Lack of health insurance among adults aged 18-64 years In Arizona Counties"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">""</span>, <span class="at">x =</span> <span class="st">"Percent"</span>) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title.position =</span> <span class="st">"plot"</span>)</span></code></pre></div>
</details>
</div>
<p>You can also extend this to multiple states to compare. You can easily query two (or more) state names, and plot them. Arizona seems to have a couple of counties that have a much higher rate compared to others.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># multi state comparison</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>two <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">state =</span> <span class="fu">c</span>(<span class="st">"AZ"</span>, <span class="st">"NV"</span>), </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">measure =</span> <span class="st">"ACCESS2"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>two <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datavaluetypeid <span class="sc">==</span> <span class="st">"AgeAdjPrv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(data_value, <span class="fu">reorder</span>(locationname, data_value), <span class="at">color =</span> stateabbr)) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> low_confidence_limit, <span class="at">xmax =</span> high_confidence_limit)) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Lack of health insurance among adults aged 18-64 years In Arizona and Nevada"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Counties"</span>, <span class="at">x =</span> <span class="st">"Percent"</span>) <span class="sc">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title.position =</span> <span class="st">"plot"</span>)</span></code></pre></div>
</details>
</div>
<p>We can go even further by comparing more states in the region. Here I have taken the average rate by state to easily compare. Texas appears to be far above the average.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>multi <span class="ot">&lt;-</span> <span class="fu">get_places</span>(<span class="at">state =</span> <span class="fu">c</span>(<span class="st">"AZ"</span>, <span class="st">"NV"</span>, <span class="st">"NM"</span>, <span class="st">"TX"</span>, <span class="st">"CA"</span>), <span class="at">measure =</span> <span class="st">"ACCESS2"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datavaluetypeid <span class="sc">==</span> <span class="st">"AgeAdjPrv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">.by =</span> <span class="st">"stateabbr"</span>, <span class="at">mean_val =</span> <span class="fu">mean</span>(data_value), <span class="at">mean_low =</span> <span class="fu">mean</span>(low_confidence_limit), <span class="at">mean_high =</span> <span class="fu">mean</span>(high_confidence_limit))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>multi <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(mean_val, <span class="fu">reorder</span>(stateabbr, mean_val), <span class="at">color =</span> stateabbr)) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> mean_low, <span class="at">xmax =</span> mean_high)) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Mean lack of health insurance among adults aged 18-64 years In Southwest States"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">""</span>, <span class="at">x =</span> <span class="st">"Percent"</span>) <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title.position =</span> <span class="st">"plot"</span>)</span></code></pre></div>
</details>
</div>]]></content:encoded>
    </item>
    <item>
      <title>Intro to Bash Scripting</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/intro-bash-scripting/</link>
      <description><![CDATA[Creating a simple R project set up tool.]]></description>
      <category>Command line</category>
      <category>R</category>
      <guid>https://brendenmsmith.com/posts/intro-bash-scripting/</guid>
      <pubDate>Wed, 15 Nov 2023 05:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p><em>And I thought R gave me super powers…</em></p>
<h2 id="introduction">Introduction</h2>
<p>Recently, I’ve been having fun with Linux. I really didn’t know much about Linux or how it was different from MacOS or Windows. All I really knew was that very smart people use it and many computers depend on it!</p>
<p>By recommendation of a friend, I tried loading Pop!_OS on an old Macbook Air I had laying around. I quickly learned how lightweight many distributions of Linux are, and how customizable they can be.</p>
<p>For anyone familiar with Linux you know that, even when you are just setting up a computer with the OS, you have to start using a bit of the command line. I had used this before learning some helpful functions with git, but nothing has exposed me to the command line and Bash more than this endeavor.</p>
<p>I have been inspired by this exposure and want to start learning more about the functionality of Bash. As a part of this, I wanted to try creating a Bash script of my own that I could implement into my current workflows.</p>
<h2 id="the-idea">The Idea</h2>
<p>I work primarily in R. And I love a good R Project. One of my usual habits for creating a project include adding sub folders and a starting script. I realized Bash is really good for doing this! So with some basic commands, I wanted to create a single executable script that makes a new R project, default sub folders, and a starting script.</p>
<h2 id="writing-the-script">Writing the Script</h2>
<p>For the script I wanted several tasks accomplished:</p>
<ol type="1">
<li>Created an R project file within a contained folder</li>
<li>Several sub-directories within that folder (data-raw, data, ref, output)</li>
<li>A blank R script file</li>
</ol>
<p>To start, I had the script ask for the name of the project. This was done by using <code>echo</code> to print the prompt, then <code>read</code> takes in the name of the project.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Please enter your project title: "</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">name</span></span></code></pre></div>
</details>
</div>
<p>Next, I had to make the script navigate to the folder I want my projects in (for me, this is a folder on my desktop called ‘R’). Then, I had a directory made with sub-folders using <code>mkdir -p</code>. Here we use <code>$name</code> to use the variable stored as the name of the project. Within the <code>{}</code> are the names of the sub-folder I most commonly use. This could be anything you like though! Lastly, <code>touch</code> creates the blank R script.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> Desktop/R</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$name</span>/<span class="dt">{</span>data-raw<span class="op">,</span>data<span class="op">,</span>ref<span class="op">,</span>output<span class="dt">}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$name</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> script.R</span></code></pre></div>
</details>
</div>
<p>Next, we have an extra step that allows RStudio to open our new project properly. When I first tried this script out, I created a blank file with the .Rproj extension to set up the project. This immediately gave me problems when I tried to open the project. Specifically, I recall an issue with the version being unspecified.</p>
<p>After a bit a research, I discovered that files with .Rproj are nothing really but a .txt file. I opened one of my existing R projects with a text editor and copied the contents exactly into the code chunk below. I wrote this text into the new R project. After some trial and error, I can confirm this method works!</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">'Version: 1.0</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">RestoreWorkspace: Default</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">SaveWorkspace: Default</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">AlwaysSaveHistory: Default</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">EnableCodeIndexing: Yes</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">UseSpacesForTab: Yes</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="st">NumSpacesForTab: 2</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="st">Encoding: UTF-8</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">RnwWeave: Sweave</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="st">LaTex: pdfLaTeX'</span> <span class="op">&gt;&gt;</span> <span class="va">$name</span>.Rproj</span></code></pre></div>
</details>
</div>
<p>The last few lines of code echo some responses to the terminal and launch the new R project.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Project </span><span class="va">$name</span><span class="st"> has been created."</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"It is stored in the R directory."</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Opening project now..."</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> <span class="va">$name</span>.Rproj</span></code></pre></div>
</details>
</div>
<h2 id="making-it-accessible">Making it Accessible</h2>
<p>For me, personally, I like to be able to execute my scripts without worrying where I am in the terminal. Once my script was working properly, I moved it to the /usr/local/bin folder.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> setupr /usr/local/bin</span></code></pre></div>
</details>
</div>
<p>And that’s it! You can find the full script code below. I hope this is helpful! It was certainly useful to me to learn more about bash and make a useful script to help me set up projects.</p>
<h2 id="full-script-code">Full Script Code</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Please enter your project title: "</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">name</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> Desktop/R</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$name</span>/<span class="dt">{</span>data-raw<span class="op">,</span>data<span class="op">,</span>ref<span class="op">,</span>output<span class="dt">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$name</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> script.R</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">'Version: 1.0</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="st">RestoreWorkspace: Default</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="st">SaveWorkspace: Default</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="st">AlwaysSaveHistory: Default</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="st">EnableCodeIndexing: Yes</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="st">UseSpacesForTab: Yes</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="st">NumSpacesForTab: 2</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="st">Encoding: UTF-8</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="st">RnwWeave: Sweave</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="st">LaTex: pdfLaTeX'</span> <span class="op">&gt;&gt;</span> <span class="va">$name</span>.Rproj</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Project </span><span class="va">$name</span><span class="st"> has been created."</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"It is stored in the R directory."</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Opening project now..."</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> <span class="va">$name</span>.Rproj</span></code></pre></div>
</details>
</div>]]></content:encoded>
    </item>
    <item>
      <title>Survival Analysis in R</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/survival-analysis/</link>
      <description><![CDATA[Exploring survival analysis with the package survival.]]></description>
      <category>R</category>
      <category>Epi</category>
      <category>ggplot2</category>
      <guid>https://brendenmsmith.com/posts/survival-analysis/</guid>
      <pubDate>Tue, 24 Oct 2023 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p><em>At first I was afraid, I was petrified…</em></p>
<h2 id="introduction">Introduction</h2>
<p>In this blog post, I’ll be exploring some basic survival analysis in R. Survival analysis focuses on describing the occurrence of an event (in this example death) in a set time frame. Survival analysis is often used in clinical research and cancer epidemiology. For more reading, I recommend visiting The Epidemiologist R Handbook page on survival analysis, as well as their listed resources. The following blog post was adapted from my biostatistics coursework and features data used in that course. We will create Kaplan-Meier plots and go through Cox Hazard Regression.</p>
<h2 id="packages-and-data">Packages and Data</h2>
<p>For this blog post, I will use the packages have, dplyr, survival.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load in libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sjPlot)</span></code></pre></div>
</details>
</div>
<p>Next, we will load the data.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sd <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/HM 878 730 Clements - Survival Analysis R Data.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#death = factor(death, levels = c(0, 1),</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                 <span class="co">#  labels = c("Living", "Died")),</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cursmoke =</span> <span class="fu">factor</span>(cursmoke, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Not current smoker"</span>, <span class="st">"Current smoker"</span>)),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">diabetes =</span> <span class="fu">factor</span>(diabetes, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Not diabetic"</span>, <span class="st">"Diabetic"</span>)),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">educ =</span> <span class="fu">factor</span>(educ, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0-11 years"</span>, <span class="st">"HS Diploma/GED"</span>, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"Some College/Vocational School"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"College degree or more"</span>)),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">prevchd =</span> <span class="fu">factor</span>(prevchd, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>)),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> <span class="fu">factor</span>(sex, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</details>
</div>
<h2 id="cox-regression">Cox Regression</h2>
<h3 id="hazard-ratios">Hazard Ratios</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(TimeDeathYears, death) <span class="sc">~</span> cursmoke <span class="sc">+</span> diabetes <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>              educ <span class="sc">+</span> prevchd <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> sex, <span class="at">data =</span> sd)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cm)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>sjPlot<span class="sc">::</span><span class="fu">tab_model</span>(cm)</span></code></pre></div>
</details>
</div>
<h3 id="survival-curves">Survival Curves</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>surv_fit_diab <span class="ot">&lt;-</span>  <span class="fu">survfit</span>(<span class="fu">Surv</span>(TimeDeathYears, death) <span class="sc">~</span> diabetes, <span class="at">data =</span> sd)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>col_diab <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lightgreen"</span>, <span class="st">"darkgreen"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  surv_fit_diab,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> col_diab,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Years"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bottomright"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Not diabetic"</span>,<span class="st">"Diabetic"</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> col_diab,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">1</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> .<span class="dv">9</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">"n"</span>)</span></code></pre></div>
</details>
</div>
<h3 id="interpretation">Interpretation</h3>
<p>Hazard ratios for the cox regression show that smoker status, diabetic status, prevalent coronary heart disease, age, sex, and the highest level of education all have significant p-values. This means that each were found to impact the outcome of death in our survival analysis.</p>
<p>Smoker status has a hazard ratio of 1.54 meaning that, compared to non-smokers, current smokers have 1.54 times the risk of death.</p>
<p>Diabetic status has a hazard ratio of 2.10. This means that those with diabetes, compared to those that were not diabetic, had 2.1 times greater risk of death.</p>
<p>Education at the level of college degree or more had a hazard ratio of 0.63. Compared to those with 0-11 years of education, this group had 37% decreased risk of death.</p>
<p>Prevalence of coronary heart disease has a hazard ratio of 2.20, meaning that compared to those without CHD, they had 120% increased risk of death.</p>
<p>Age also has a significant p-value, and a hazard ratio of 1.10. This means for every increase unit in age, there is 10% greater risk of death.</p>
<p>Lastly, sex had a hazard ratio of 1.96. This means that compared to females, males had 95% greater risk of death.</p>
<p>The survival curve shows the difference in survival probability between diabetics and non-diabetics. The differences are quite noticeably, with a lower survival probability among diabetics. This is in line with the results of the cox regression. For example, at 10 years, the survival probability among non-diabetics is about 85%, while the probability among diabetics is 65%.</p>
<h2 id="kaplan-meier">Kaplan-Meier</h2>
<p><strong>Conduct Kaplan-Meier for each categorical IV. Interpret the summary, mean and median survival time, Log Rank Mantel-Cox Test, survival probability at 10 years. Compare and contrast between each variable.</strong></p>
<h3 id="function-for-analysis">Function for Analysis</h3>
<p>Because I have to compare quite a few variables, I make a quick function to output exactly what I need.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>km <span class="ot">&lt;-</span> <span class="cf">function</span>(time, event, data, iv, title_label){</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span>  <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, event) <span class="sc">~</span> iv, <span class="at">data =</span> sd)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">4</span>, <span class="st">"Set1"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>plot_title <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Survival Curve by"</span>, title_label)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> cols,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> plot_title,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Years"</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bottomleft"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="fu">levels</span>(iv),</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> cols,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">1</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> .<span class="dv">9</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">2</span>), <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">col =</span> <span class="st">"gray75"</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model summary with mean and median: </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model, <span class="at">print.rmean =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>logrank <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, event) <span class="sc">~</span> iv, <span class="at">data =</span> data)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(logrank)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<h3 id="diabetes">Diabetes</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">km</span>(sd<span class="sc">$</span>TimeDeathYears, sd<span class="sc">$</span>death, sd, sd<span class="sc">$</span>diabetes, <span class="st">"Diabetes"</span>)</span></code></pre></div>
</details>
</div>
<p>As interpreted before, the survival probability differs quite drastically between these two groups. At 10 years, the survival probability among non-diabetics is about 85%, while the probability among diabetics is 65%.</p>
<p>The model summary shows the total number in each group and the number of events (deaths) in each group.</p>
<p>The mean survival time is 13.7 years for non-diabetics, compared to 11.8 for diabetics. The median survival time could not be computed for non-diabetics, and was 14 years for diabetics. The median was not computed for non-diabetics because over 50% were still alive by the end of the time period.</p>
<p>The Log Rank Mantel-Cox Test shows a resulting p-value of &lt;0.0001, meaning that the null hypothesis, that there is no difference in survival between groups, is rejected.</p>
<h3 id="smoker-status">Smoker Status</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">km</span>(sd<span class="sc">$</span>TimeDeathYears, sd<span class="sc">$</span>death, sd, sd<span class="sc">$</span>cursmoke, <span class="st">"Smoker Status"</span>)</span></code></pre></div>
</details>
</div>
<p>The model results show that the mean survival time was 13.6 among non-smokers and 13.5 among current smokers. These are not very different from each other, and on par with the average survival time of non-diabetics. The median survival times were not able to be calculated for this variable.</p>
<p>The Log Rank test shows a p-value of 0.5 indicating we should accept the null hypothesis that there is no difference in survival between the two groups.</p>
<p>At 10 years, the survival probability is nearly the same between the two groups, a bit greater than 80%. Once again, similar to non-diabetic suvival probability at the same time.</p>
<h3 id="education-level">Education Level</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">km</span>(sd<span class="sc">$</span>TimeDeathYears, sd<span class="sc">$</span>death, sd, sd<span class="sc">$</span>educ, <span class="st">"Education"</span>)</span></code></pre></div>
</details>
</div>
<p>This model summary compares each of the four education levels in our variable. The mean survival years for those 0-11 is 13.2, for HS/Diploma/GED it is 13.8, for Some College/Vocational School it is 13.9 and for College degree or more it is 14. These are close to the averages we saw among smokers/nonsmokers, and non-diabetics. However, diabetics have still had the lowest average at 11 years. Once again, the medians could not be calculated for this variable because of the high proportion of groups surviving by the end of the time period.</p>
<p>The Log Rank test shows a p-value of &lt;0.0001. This leads us to reject the null and accept the alternative hypothesis that there is a significant difference in survival time between these groups (somewhere).</p>
<p>The survival probability at 10 years is 80% for the group 0-11, and around 90% for the other three groups. This is in the range of most groups thus far, aside from diabetics.</p>
<h3 id="prevalence-of-coronary-heart-disease">Prevalence of Coronary Heart Disease</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">km</span>(sd<span class="sc">$</span>TimeDeathYears, sd<span class="sc">$</span>death, sd, sd<span class="sc">$</span>prevchd, <span class="st">"CHD Prevalence"</span>)</span></code></pre></div>
</details>
</div>
<p>Those without coronary heart disease had an average survival time of 13.8 years, while those with CHD had an average of 11.7 years. The median was only calculated for those with CHD, which was at 14 years. These metrics align with results from many other groups. the average survival years for those without CHD is comparable to the same metrics examined among the three highest education levels, smokers and non-smokers, and non-diabetics. Diabetics and those with CHD have similar average survival time.</p>
<p>The Log Rank Test shows a p-value of less than 0.0001. This leads us to reject the null and accept the alternative hypothesis that there is a difference in survival times between the two groups.</p>
<p>Looking at the survival curve, the survival probability of those with CHD at 10 years is about 65%. The survival probability of those without CHD is around 90%. This is a comparable split to diabetics/non-diabetics.</p>
<h3 id="sex">Sex</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">km</span>(sd<span class="sc">$</span>TimeDeathYears, sd<span class="sc">$</span>death, sd, sd<span class="sc">$</span>sex, <span class="st">"Sex"</span>)</span></code></pre></div>
</details>
</div>
<p>For the Kaplan-Meier examining sex, the model results show that the average survival time among females was 13.9 compared to male’s 13.1. This is a similar split between the highest and lowest education levels. Overall, this seems to be a significant difference, but not as big of a difference as CHD or diabetes status. The medians for these groups could not be calculated.</p>
<p>The Log Rank Test shows a p-value of less than 0.0001, which again leads us to accept the alternative hypothesis that this model shows a significant difference in survival time between the two groups.</p>
<p>On the survival curve, it appears that at 10 years, males had 80% survival probability, and females had about 90%. This is a much closer gap, agian comparable to the difference between education level. The gap is narrower among smokers and non-smokers, but larger when diabetes or CHD is examined.</p>
<h2 id="reflections-on-cox-regression-vs.-kaplan-meier">Reflections on Cox Regression vs.&nbsp;Kaplan-Meier</h2>
<p>The cox regression showed that smoker status, diabetes status, education level (college degree or more), CHD status, age, and sex were all statistically significant in the model. The highest increased hazard ratios were from the variables for CHD and diabetes.</p>
<p>When we examine the Kaplan-Meier and Log Rank tests, all categorical variables were significant except for smoker status. This difference was not expected. Being that the cox regression showed it as significant and with a fairly high hazard ratio, I expected to see a bigger difference in survival time. Perhaps this is due to comorbidities associated with this variable. But the two largest hazard ratios in the cox regression, diabetes and CHD, displayed the biggest differences in suvival time, which was expected. Also, variables like education and sex showed smaller but still present difference in line with cox regression results.</p>
<p>Cox regression is obviously necessary whenever you are interested in a continuous variable’s relationship to the outcome. It is also preferred when you have multiple groups in a categorical variables. As we saw in this project, education level was shown as significant using both methods. However, cox regression gave us a greater level of detail of increased risk within groups. The Kaplan-Meier (and Log Rank test) simply told us there was a significant difference somewhere within the groups.</p>
<p>There are other advantages to picking a particular method. For instance, if you are more interested in metrics like average survival time, KP delivers that information. If you are looking for information for example in a clinical trial, a cox regression may be preferable due to the hazard ratio it gives you. This may be more practical too if you are interested in multiple factors influencing an outcome. KP is limited to one factor at a time.</p>
<p>Lastly, Kaplan-Meier may be the most reliable method to use if you have data that do not meet the proper assumptions, as KP is a non-parametric test. Cox regression is semi-parametric, meaning there are some assumptions that must be met. In this way, it may be easier to apply KP to ill fitting data. But one method is not “better” than the other, they are simply different techniques that answer slightly different questions.</p>]]></content:encoded>
    </item>
    <item>
      <title>HM878: Helper Functions</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/hm878-helper-functions/</link>
      <description><![CDATA[A walkthrough of the helper functions in the package hm878]]></description>
      <category>R</category>
      <category>packages</category>
      <category>vignette</category>
      <guid>https://brendenmsmith.com/posts/hm878-helper-functions/</guid>
      <pubDate>Thu, 12 Oct 2023 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="introduction">Introduction</h1>
<p>This vignette demonstrates how to use the functions included in this package so far. If you have not yet, install the package with the following code: <code>devtools::install_github("brendensm/hm878")</code>. If you do not have the package devtools, be sure to install that first <code>install.packages("devtools")</code>.</p>
<p>To start, we load the package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hm878)</span></code></pre></div>
</div>
<p>Let’s assume we are running a binomial logistic regression using the data from <code>mtcars</code>, a built-in data set included with R. We will use <code>vs</code> (engine type as V-shaped or straight) as the dependent variable, and <code>cyl</code> (number of cylinders) as the independent variable. We will store our models for block 1 and block 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mb1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(vs <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> mtcars, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mb2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(vs <span class="sc">~</span> cyl, <span class="at">data =</span> mtcars, <span class="at">family =</span> <span class="st">"binomial"</span>)</span></code></pre></div>
</div>
<h2 id="testing-goodness-of-fit-with-chi_log">Testing Goodness of Fit with <code>chi_log</code></h2>
<p>To assess the fit of our models, we may want to use the function <code>chi_log</code>. To use it, simply type in the name of your model as the first argument, followed by the data set that the model uses. Optionally, you can provide labels for each model using the third argument. Here I will label each block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chi_log</span>(mb1, mtcars, <span class="st">"Block 1"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chi_log</span>(mb2, mtcars, <span class="st">"Block 2"</span>)</span></code></pre></div>
</div>
<p>The function gives us the chi-squared statistic, degrees of freedom, and a p-value. It also reminds us of the null and alternative hypotheses. Both models appear to be a good fit.</p>
<h2 id="accuracy-percentage-with-predict_percent">Accuracy Percentage with <code>predict_percent</code></h2>
<p>We may want to also check the accuracy of our models. To do this, we can use <code>predict_percent</code>. To use this function, enter the name of the model in the first argument, followed by the dependent variable we used in the model. For this, we must use the data$variable format. In the example below, we use the variable <code>vs</code> from the data set <code>mtcars</code>. Once again, we can label the output with a string as the optional third argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict_percent</span>(mb1, mtcars<span class="sc">$</span>vs, <span class="st">"Block 1"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict_percent</span>(mb2, mtcars<span class="sc">$</span>vs, <span class="st">"Block 2"</span>)</span></code></pre></div>
</div>
<h2 id="calculating-odds-ratios-with-or">Calculating Odds Ratios with <code>or</code></h2>
<p>To calculate odds ratios for the models, simply pass the model through the function <code>or</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">or</span>(mb1)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">or</span>(mb2)</span></code></pre></div>
</div>
<p>The output results in a data frame with the odds ratios, confidence intervals, and p-values.</p>
<h2 id="upper-and-lower-fences-with-fences">Upper and Lower Fences with <code>fences</code></h2>
<p>If you want to revise and adjust your model, it can be helpful to limit outliers. To find upper and lower fences quickly, use the function <code>fences</code>. To do this, pass the continuous variable you are interested in examining through the function. Once again, use the format data$variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#fences(iris$Sepal.Length)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#fences(mtcars$cyl)$Upper</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#fences(mtcars$cyl)$Lower</span></span></code></pre></div>
</div>
<h2 id="comparing-model-results-with-compare_models">Comparing Model Results with <code>compare_models</code></h2>
<p>Lastly, when you are putting together multiple models, it can be helpful to view them all at the same time, next to one another. This is particularly helpful if you have more than two models you are comparing. For this function, pass through however many models you have to compare, and optionally label each one, using a vector of strings for each model. To demonstrate, I will add on another model <code>mb3</code> that will have another continuous independent variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mb3 <span class="ot">&lt;-</span> <span class="fu">glm</span>(vs <span class="sc">~</span> cyl <span class="sc">+</span> wt, <span class="at">data =</span> mtcars, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_models</span>(mb1, mb2, mb3, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Model 1 Block 1"</span>, <span class="st">"Model 1 Block 2"</span>, <span class="st">"Model Block 3"</span>))</span></code></pre></div>
</div>
<h2 id="deviance_aic-pull-the-deviances-and-aics-from-model-summarys"><code>deviance_aic</code> Pull the Deviances and AICs from model summarys</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">deviance_aic</span>(mb1, mb2, mb3)</span></code></pre></div>
</div>]]></content:encoded>
    </item>
    <item>
      <title>Twitter Bots</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/twitter-bots/</link>
      <description><![CDATA[‘Suppose I were to begin by saying that I had fallen in love with a color.’]]></description>
      <category>R</category>
      <category>color</category>
      <category>web-scraping</category>
      <guid>https://brendenmsmith.com/posts/twitter-bots/</guid>
      <pubDate>Wed, 01 Mar 2023 05:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p><em>Update: Since a certain someone took over the bird app, this bot is no longer functional. Unfortunately, it is not worth paying $100/month to post random shades of blue. What an injustice.</em></p>
<h2 id="introduction">Introduction</h2>
<p>Blue is a color that moves me. I love how many forms it can take, the way its shades can channel moods. I recently reread my copy of Maggie Nelson’s <em>Bluets</em> and felt inspired to revisit an older project of mine. Possibly the first R project I put together (that was more fun, and not statistics or graphic related) was my twitter bot, everywordisblue.</p>
<p>This was a year or so back when I was just starting to dust off R and commit to learning the language fully. The original account was influenced by many of the silly bots on the website and my personal passion for the color blue. It took a randomly selected noun, pasted the word <code>'blue'</code> in front of it, and posted it straight to Twitter once a day. While this creation gave me some immediate satisfaction (and some interesting results), I did feel that the account was a bit too simplistic; I always wanted to do more.</p>
<p>Infinitely more satisfying would be a randomly selected hue of blue, shared daily, completely automated. To do this required editing my original script and, most importantly, web-scraping a data set of blue colors with accompanying hex codes. Follow along and let’s build something fun!</p>
<h2 id="the-data">The Data</h2>
<p>Originally, I attempted to find an existing data set. Most colors sets I’m familiar with using in R, however, are not as hyper-fixated on a singular color. I quickly found <a href="color-names.com">color-names.com</a>, and noticed when you simply search for the word <code>'blue'</code>, the search provides over 89 pages (12 colors on each page), giving over a thousand colors with hex codes. This seemed like an adequate source for this project and a great way to practice web scraping data from R.</p>
<h3 id="using-rvest">Using ‘rvest’</h3>
<p>To help us source our data, the library <code>'rvest'</code> provides everything we need. In order to create a data frame containing the color name and the hex code, we need to:</p>
<ul>
<li><p>import the web search’s html</p></li>
<li><p>pull out the two elements from the code (name, hex code)</p></li>
<li><p>then repeat this process for each of the 89 pages</p></li>
</ul>
<p>The function <code>'read_html'</code> from <code>rvest</code> makes the first step incredibly easily. For this, we simply pass in the web address as an argument in the function and save the output as a new value called <code>'page'</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>link <span class="ot">&lt;-</span> <span class="st">"https://www.color-name.com/search/blue"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>page <span class="ot">&lt;-</span> <span class="fu">read_html</span>(link)</span></code></pre></div>
</details>
</div>
<p>Next, we’ll pass <code>'page'</code> into the function <code>'html_nodes'</code> and then into <code>'html_text'</code> to extract the desired string vector. The text passed through <code>'html_nodes'</code> must be sourced from the webpage you are scraping from. You can use the ‘inspect’ feature in Google Chrome, or the Chrome extension <a href="https://chrome.google.com/webstore/detail/selectorgadget/mhjhnkcfbdhnjickkkdbjoemdmbfginb?hl=en">‘SelectorGadget’</a> to find the proper tag to use.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>name <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span> <span class="fu">html_nodes</span>(<span class="st">"h2 a"</span>) <span class="sc">|&gt;</span> <span class="fu">html_text</span>()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>hex <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span> <span class="fu">html_nodes</span>(<span class="st">".hx"</span>) <span class="sc">|&gt;</span> <span class="fu">html_text</span>()</span></code></pre></div>
</details>
</div>
<p>Once that is done, we can take both vectors and create a data frame.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(name, hex, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
</div>
<p>In order to collect each page of data, it is easiest to use a for loop. For this we make a couple of changes. First, we will create an empty data frame titled <code>'colors'</code> to store data in for each iteration of the loop. Because there are 89 pages, we set the for loop to iterate that many times. We store this as <code>'page_result'</code> in the loop and change the url to match what is displayed on each page number then use <code>'paste0'</code> to put them together. Lastly, I added <code>'rbind'</code> to add the new rows to the <code>'colors'</code> data frame and a print command to keep track of the loop progress.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (page_result <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">89</span>){</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  link <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.color-name.com/search/blue/page/"</span>, page_result)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  page <span class="ot">&lt;-</span> <span class="fu">read_html</span>(link)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span> <span class="fu">html_nodes</span>(<span class="st">"h2 a"</span>) <span class="sc">|&gt;</span> <span class="fu">html_text</span>()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  hex <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span> <span class="fu">html_nodes</span>(<span class="st">".hx"</span>) <span class="sc">|&gt;</span> <span class="fu">html_text</span>()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  colors <span class="ot">&lt;-</span> <span class="fu">rbind</span>(colors, <span class="fu">data.frame</span>(name, hex, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Page:"</span>, page_result))</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<p>And as a last step, I decided to clean up the colors a bit. Even though the search used the key word <code>'blue'</code>, I noticed that the last page displayed colors that did not have the word <code>'blue'</code> in the title. To fix this, I filtered out any color that did not contain the word.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>blues <span class="ot">&lt;-</span> colors <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">'Blue'</span>, name))</span></code></pre></div>
</details>
</div>
<h2 id="the-script">The Script</h2>
<p>Now that we have the data, we need to make a script that randomly selects a color, creates a color square, saves it as an image, and posts a tweet. For all of this, we will load <code>'rtweet'</code> and <code>'ggplot2'</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rtweet)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
</details>
</div>
<p>After importing, we need to create the token to interact with Twitter’s API. You can find a deeper dive into this process <a href="https://www.r-bloggers.com/2022/04/r-access-to-twitters-v2-api/">here.</a> In my example below, I have stored my information as secrets in my Github repository.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>blues <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"blues_dataset.csv"</span>)[,<span class="sc">-</span><span class="dv">1</span>] <span class="co"># import data </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>everywordisblue_token <span class="ot">&lt;-</span> <span class="co"># Twitter token business</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  rtweet<span class="sc">::</span><span class="fu">rtweet_bot</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">api_key =</span>   <span class="fu">Sys.getenv</span>(<span class="st">"TWITTER_CONSUMER_API_KEY"</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">api_secret =</span> <span class="fu">Sys.getenv</span>(<span class="st">"TWITTER_CONSUMER_API_SECRET"</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">access_token =</span>    <span class="fu">Sys.getenv</span>(<span class="st">"TWITTER_ACCESS_TOKEN"</span>),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">access_secret =</span>  <span class="fu">Sys.getenv</span>(<span class="st">"TWITTER_ACCESS_TOKEN_SECRET"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</details>
</div>
<p>Next we can select a single row in our main data frame by calling <code>'sample_n'</code>. Then to separate the name and the hex code we can save each as an object and index using brackets.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>random_blue <span class="ot">&lt;-</span> <span class="fu">sample_n</span>(blues, <span class="dv">1</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">as.character</span>(random_blue[<span class="dv">1</span>])</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>blue_hex <span class="ot">&lt;-</span> <span class="fu">as.character</span>(random_blue[<span class="dv">2</span>])</span></code></pre></div>
</details>
</div>
<p>To create a square with the randomly selected color, we can create an empty ggplot, add <code>'theme_void'</code> to make it blank, and use theme to use the selected hex code. For this we use arguments <code>'plot.background'</code> and <code>'panel.background'</code>. Then we can use <code>'ggsave'</code> to save a copy of this as an image and specify the desired path.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>blue_square <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>              <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> blue_hex),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> blue_hex))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">"blue_squares/"</span>, temp, <span class="st">".png"</span>), blue_square,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">150</span>, <span class="at">height =</span> <span class="dv">150</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span></code></pre></div>
</details>
</div>
<p>Now that all the pieces are in place, we can assemble the tweet and sent it out! The function <code>'post_tweet'</code> now requires that the user provides alt text (awesome!) so we will first save that (this will be the same for each tweet sent). We will also save an image path that changes each time the script is run using <code>'paste0'</code> once again.</p>
<p>To send the actual tweet, we pull in each object to the <code>'post_tweet'</code> and we are done!</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>alt_text <span class="ot">&lt;-</span> <span class="st">"A random shade of blue, sourced from color-name.com."</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>image_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"blue_squares/"</span>, temp, <span class="st">".png"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>rtweet<span class="sc">::</span><span class="fu">post_tweet</span>(<span class="at">status =</span> temp, </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">media =</span> image_path, </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">media_alt_text =</span> alt_text,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">token =</span> everywordisblue_token)</span></code></pre></div>
</details>
</div>
<h2 id="automation-with-github-actions">Automation with Github Actions</h2>
<p>Github makes it surprisingly easy to automate scripts with Github Actions! Again for the full length guide on this process I will direct you to Matt Dray’s <a href="https://www.rostrum.blog/2020/09/21/londonmapbot/">blog post</a> which taught me how to properly set this bot up.</p>
<p>Essentially, all that is needed in a yml file that lists the correct instructions on when and what to run. My example yml is below:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode yml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> blue-version-2</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> </span><span class="st">'0 0 * * *'</span><span class="co">  # once every day</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">blue-post</span><span class="kw">:</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> macOS-latest</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">TWITTER_CONSUMER_API_KEY</span><span class="kw">:</span><span class="at"> ${{ secrets.TWITTER_CONSUMER_API_KEY }}</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">TWITTER_CONSUMER_API_SECRET</span><span class="kw">:</span><span class="at"> ${{ secrets.TWITTER_CONSUMER_API_SECRET }}</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">TWITTER_ACCESS_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.TWITTER_ACCESS_TOKEN }}</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">TWITTER_ACCESS_TOKEN_SECRET</span><span class="kw">:</span><span class="at"> ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/setup-r@v2</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install rtweet package</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> Rscript -e 'install.packages("rtweet", dependencies = TRUE)'</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dplyr</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> Rscript -e 'install.packages("dplyr", dependencies = TRUE)'</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install ggplot2</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> Rscript -e 'install.packages("ggplot2", dependencies = TRUE)'</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Create and post tweet</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> Rscript blue-script.R</span></span></code></pre></div>
</details>
</div>
<p>And that’s it! If you want to check out the live twitter bot you can follow it <a href="https://twitter.com/everywordisblue">here.</a></p>]]></content:encoded>
    </item>
    <item>
      <title>Michigan COVID-19 County Maps</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/michigan-covid-maps/</link>
      <description><![CDATA[Two quick, interactive COVID-19 maps.]]></description>
      <category>R</category>
      <category>maps</category>
      <guid>https://brendenmsmith.com/posts/michigan-covid-maps/</guid>
      <pubDate>Tue, 11 Oct 2022 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>This post is intended to demonstrate some basic ways to map data in R. For our example, we will be creating a choropleth map of Michigan’s counties featuring COVID-19 data. The result is something quite similar to the map featured on the <a href="https://www.michigan.gov/coronavirus/stats">state’s dashboard.</a> The data used in this post is from October 4, 2022.</p>
<p>For the sake of practice, we will walk through two different ways to go about this process. First we will use ggplot2. We will use a function called <code>map_data</code> to pull in shape file data easily. In our second example, we will use leaflet to create a better looking version of this map and use a raw shape file.</p>
<h2 id="ggplot2-map">Ggplot2 map</h2>
<p>To start, we will make a base map with <code>ggplot2</code> and make it interactive with <code>plotly</code>. First, as always, we load in the libraries we will be using.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages -----------------------------------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># really just dplyr but the whole verse can't hurt</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx) <span class="co"># to read in excel data</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly) <span class="co"># for the interactive part</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer) <span class="co"># to set our color palette</span></span></code></pre></div>
</details>
</div>
<p>Next, we will get our county map. To do this we can simply call the function map_data and specify that we want it at the county level. This will give us data for every county in the US. Because we are only mapping Michigan, we add a second line to subset our first data frame ‘counties’ to only include Michigan.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the base state map -------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>counties <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">"county"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>mi_county <span class="ot">&lt;-</span> <span class="fu">subset</span>(counties, region <span class="sc">==</span> <span class="st">"michigan"</span>)</span></code></pre></div>
</details>
</div>
<p>For our COVID-19 data, I am importing an older file from state’s website (linked previously). If you want a current version to follow along, you can find it there. Once the file is loaded into R Studio, we need to make a few adjustments. The original file splits the cases into two categories, confirmed and probable. On the state’s dashboard, they combine these numbers into a total for map reporting. We will do the same. This is easily done with the <code>group_by</code> and <code>summarise</code> functions. We will also change the county names to lowercase in preparation for merging.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data prep ---------------------------------------------------------------</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>micovid <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"Cases and Deaths by County 2022-10-04.xlsx"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>micovid <span class="ot">&lt;-</span> micovid <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(COUNTY) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_cases =</span> <span class="fu">sum</span>(Cases),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_deaths =</span> <span class="fu">sum</span>(Deaths)) <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">subregion =</span> <span class="fu">tolower</span>(COUNTY))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>cases_and_county <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(mi_county, micovid, <span class="at">by =</span> <span class="st">"subregion"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>cases_and_county <span class="ot">&lt;-</span> cases_and_county <span class="sc">%&gt;%</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">county =</span> COUNTY)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cases_and_county<span class="ot">&lt;-</span> cases_and_county <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Category =</span> <span class="fu">case_when</span>(total_cases <span class="sc">&lt;</span> <span class="dv">1000</span> <span class="sc">~</span> <span class="st">'0-999'</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                              total_cases <span class="sc">&lt;</span> <span class="dv">5000</span> <span class="sc">~</span> <span class="st">'1000-4999'</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                              total_cases <span class="sc">&lt;</span><span class="dv">15000</span> <span class="sc">~</span> <span class="st">'5000-14999'</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                              total_cases <span class="sc">&lt;</span> <span class="dv">30000</span> <span class="sc">~</span> <span class="st">'15000-29999'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                              total_cases <span class="sc">&lt;</span> <span class="dv">100000</span><span class="sc">~</span> <span class="st">'30000-99999'</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                              total_cases <span class="sc">&lt;</span> <span class="dv">1000000</span> <span class="sc">~</span> <span class="st">'100000+'</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">'NA'</span>))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>cases_and_county<span class="sc">$</span>Category <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(cases_and_county<span class="sc">$</span>Category)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>lvls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'0-999'</span>, </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">'1000-4999'</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">'5000-14999'</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>          <span class="st">'15000-29999'</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>          <span class="st">'30000-99999'</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>          <span class="st">'100000+'</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>cases_and_county<span class="sc">$</span>Category <span class="ot">&lt;-</span> <span class="fu">fct_relevel</span>(cases_and_county<span class="sc">$</span>Category, lvls)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Making the map ----------------------------------------------------------</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#ACD1E7"</span>, <span class="st">"#82BADC"</span>, <span class="st">"#59A1CF"</span>, <span class="st">"#236893"</span>,<span class="st">"#174562"</span>, <span class="st">"#122548"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>label <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bgcolor =</span> <span class="st">"#EEEEEE"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">font =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">"black"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>noax <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">""</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">zeroline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">showline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">showticklabels =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">showgrid =</span> <span class="cn">FALSE</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> cases_and_county <span class="sc">%&gt;%</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(long, lat, </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">group =</span> group,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">text =</span> <span class="fu">paste</span>(<span class="st">'&lt;/br&gt;County:'</span>, county, <span class="st">'&lt;/br&gt;Category:'</span>, Category,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                             <span class="st">'&lt;/br&gt;Cases:'</span>, total_cases)))<span class="sc">+</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"black"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">data =</span> cases_and_county, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Category))<span class="sc">+</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> p) </span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(g, <span class="at">tooltip =</span> <span class="fu">c</span>(<span class="st">"text"</span>), <span class="at">width =</span> <span class="dv">700</span>, <span class="at">height =</span> <span class="dv">600</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="at">xaxis =</span> noax,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">yaxis =</span> noax) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">style</span>(<span class="at">hoverlabel =</span> label) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">config</span>(<span class="at">displayModeBar =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
</div>
<h2 id="using-leaflet">Using Leaflet</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># leaflet -----------------------------------------------------------------</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>miCounties <span class="ot">&lt;-</span> <span class="fu">counties</span>(<span class="at">state =</span> <span class="st">"MI"</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>, <span class="at">progress_bar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>micovid <span class="ot">&lt;-</span> micovid <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAME =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    COUNTY <span class="sc">==</span> <span class="st">"St Clair"</span> <span class="sc">~</span> <span class="st">"St. Clair"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    COUNTY <span class="sc">==</span> <span class="st">"St Joseph"</span> <span class="sc">~</span> <span class="st">"St. Joseph"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> COUNTY</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">merge</span>(miCounties, micovid)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># pals and labels for each map -------------------------------------------------------</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>case_bins <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="dv">5000</span>, <span class="dv">15000</span>, <span class="dv">30000</span>, <span class="dv">100000</span>, <span class="cn">Inf</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>case_pal <span class="ot">&lt;-</span> <span class="fu">colorBin</span>(<span class="st">"Blues"</span>, <span class="at">domain =</span> combined<span class="sc">$</span>total_cases, <span class="at">bins =</span> case_bins)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>case_labels <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"&lt;strong&gt;%s&lt;/strong&gt;&lt;br/&gt;Cases: %g"</span>,</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  combined<span class="sc">$</span>NAME, combined<span class="sc">$</span>total_cases</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(htmltools<span class="sc">::</span>HTML)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>death_bins <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">500</span>, <span class="dv">1500</span>, <span class="dv">3000</span>, <span class="cn">Inf</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>death_pal <span class="ot">&lt;-</span> <span class="fu">colorBin</span>(<span class="st">"Reds"</span>, <span class="at">domain =</span> combined<span class="sc">$</span>total_deaths, <span class="at">bins =</span> death_bins)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>death_labels  <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"&lt;strong&gt;%s&lt;/strong&gt;&lt;br/&gt;Deaths: %g"</span>,</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  combined<span class="sc">$</span>NAME, combined<span class="sc">$</span>total_deaths</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(htmltools<span class="sc">::</span>HTML)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>(<span class="at">group =</span> <span class="st">"base"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> combined,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>              <span class="at">group =</span> <span class="st">"Cases"</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>              <span class="at">fillColor =</span> <span class="sc">~</span><span class="fu">case_pal</span>(total_cases),</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>              <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>              <span class="at">opacity =</span> <span class="dv">1</span>,</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"white"</span>,</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>              <span class="at">dashArray =</span> <span class="st">"3"</span>,</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>              <span class="at">fillOpacity =</span> <span class="fl">0.7</span>,</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>              <span class="at">highlightOptions =</span> <span class="fu">highlightOptions</span>(</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>                <span class="at">weight =</span> <span class="dv">5</span>,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"#666"</span>,</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>                <span class="at">dashArray =</span> <span class="st">""</span>,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>                <span class="at">fillOpacity =</span> <span class="fl">0.7</span>,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>                <span class="at">bringToFront =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> case_labels,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">labelOptions =</span> <span class="fu">labelOptions</span>(</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>                <span class="at">style =</span> <span class="fu">list</span>(<span class="st">"font-weight"</span> <span class="ot">=</span> <span class="st">"normal"</span>, <span class="at">padding =</span> <span class="st">"3px 8px"</span>),</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>                <span class="at">textsize =</span> <span class="st">"15px"</span>,</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>                <span class="at">direction =</span> <span class="st">"auto"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLegend</span>(<span class="at">data =</span> combined,</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Cases"</span>,</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>            <span class="at">pal =</span> case_pal, <span class="at">values =</span> <span class="sc">~</span>total_cases, <span class="at">opacity =</span> <span class="fl">0.7</span>,</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="st">"bottomright"</span>, <span class="at">group =</span> <span class="st">"Cases"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> combined,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>              <span class="at">group =</span> <span class="st">"Deaths"</span>,</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">fillColor =</span> <span class="sc">~</span><span class="fu">death_pal</span>(total_deaths),</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>              <span class="at">opacity =</span> <span class="dv">1</span>,</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"white"</span>,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>              <span class="at">dashArray =</span> <span class="st">"3"</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>              <span class="at">fillOpacity =</span> <span class="fl">0.7</span>,</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>              <span class="at">highlightOptions =</span> <span class="fu">highlightOptions</span>(</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>                <span class="at">weight =</span> <span class="dv">5</span>,</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"#666"</span>,</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>                <span class="at">dashArray =</span> <span class="st">""</span>,</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>                <span class="at">fillOpacity =</span> <span class="fl">0.7</span>,</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>                <span class="at">bringToFront =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> death_labels,</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>              <span class="at">labelOptions =</span> <span class="fu">labelOptions</span>(</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>                <span class="at">style =</span> <span class="fu">list</span>(<span class="st">"font-weight"</span> <span class="ot">=</span> <span class="st">"normal"</span>, <span class="at">padding =</span> <span class="st">"3px 8px"</span>),</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>                <span class="at">textsize =</span> <span class="st">"15px"</span>,</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>                <span class="at">direction =</span> <span class="st">"auto"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLegend</span>(<span class="at">data =</span> combined, </span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Deaths"</span>,</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>            <span class="at">pal =</span> death_pal, <span class="at">values =</span> <span class="sc">~</span>total_deaths, <span class="at">opacity =</span> <span class="fl">0.7</span>,</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="st">"bottomright"</span>, <span class="at">group =</span> <span class="st">"Deaths"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLayersControl</span>(<span class="at">overlayGroups =</span> <span class="fu">c</span>(<span class="st">"Cases"</span>, <span class="st">"Deaths"</span>),</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>                   <span class="at">options =</span> <span class="fu">layersControlOptions</span>(<span class="at">collapsed =</span> <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hideGroup</span>(<span class="st">"Deaths"</span>)</span></code></pre></div>
</details>
</div>]]></content:encoded>
    </item>
    <item>
      <title>Opioid Plotting Practice</title>
      <dc:creator>Brenden Smith</dc:creator>
      <link>https://brendenmsmith.com/posts/opioid-plotting/</link>
      <description><![CDATA[A basic ggplot2 walkthrough and an introduction to plotly.]]></description>
      <category>R</category>
      <category>ggplot2</category>
      <guid>https://brendenmsmith.com/posts/opioid-plotting/</guid>
      <pubDate>Sun, 09 Oct 2022 04:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Over the summer, I took a course on public health surveillance. As a culminating project, we were tasked with creating original data visualizations for a fact sheet on a topic of our choosing. I chose to examine local opioid overdose and mortality data for my project.</p>
<p>This is a topic that is near to me. The opioid crisis has impacted many communities across the country. At this point, the topic is well known to most people. Despite awareness, overdoses are still rising.</p>
<p>In the following post, I will demonstrate how easily you can spice up basic ggplot graphics. In particular we will look at:</p>
<ul>
<li><p>a basic ggplot2 line chart</p></li>
<li><p>ggthemes we can use to make a more professional looking figure</p></li>
<li><p>and a brief glimpse at plotly (because interactive graphs are so cool!)</p></li>
</ul>
<h2 id="data-prep">Data Prep</h2>
<p>To begin, we will load in our libraries. Be sure to install them if you haven’t already.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span></code></pre></div>
</div>
<p>Next, we will read in our data using readxl. The data I am using comes from the Michigan Substance Use Disorder Data Repository (SUDDR). You can download the data yourself <a href="https://mi-suddr.com/opioids/">here</a>. Keep in mind that the numbers we are working with in this example are raw counts of opioid overdose deaths by county, NOT rates. Therefore, we should not compare these counties against each other without considering population size differences. I’m interested in looking at changes over time with this dataset.</p>
<p>Because I’m focusing on the three counties in my area, I’m going to create a vector with the names of the capital area counties. This will make subsetting the data a little easier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>opdeaths <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"Opioid Overdose Deaths.xlsx"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>counties <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Ingham"</span>, <span class="st">"Eaton"</span>, <span class="st">"Clinton"</span>)</span></code></pre></div>
</div>
<h2 id="time-to-plot">Time to Plot!</h2>
<p>From here, we can start our first plot. I will select my target counties using the <code>filter()</code> function that comes from the dplyr package. Be sure to specify which aesthetics you want to plot on the respective axes. Here we are putting the variable <code>Year</code> on the x-axis and <code>Opioid Overdose Deaths</code> on the y.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>opdeaths <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(County <span class="sc">%in%</span> counties) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> <span class="st">`</span><span class="at">Opioids Overdose Deaths</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div>
</div>
<p>Oh no! What happened? We didn’t tell ggplot which lines we wanted to see. It is important that within the layer <code>geom_line()</code> we specify that we want to plot different lines based on our county variable. To do this, we simply add an <code>aes()</code> layer and assign <code>color</code> to <code>County</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>opdeaths <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(County <span class="sc">%in%</span> counties) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> <span class="st">`</span><span class="at">Opioids Overdose Deaths</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> County))</span></code></pre></div>
</div>
<p>That looks a lot better! But we can do more. The lines look a bit skinny to me. I would like them to stand out more. It also might help to adjust the opacity of the lines. This can make points that cross over easier to read. To make these changes, we can specify <code>linewidth</code> and <code>alpha</code> in <code>geom_line()</code> outside of the <code>aes()</code> argument.</p>
<p>I think it would be great to add points to our plot, too. Like the <code>geom_line()</code> layer, I want these to be large enough and overlap easily. I will pass through similar arguments in the <code>geom_point()</code> layer, also specifying the <code>color</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>opdeaths <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(County <span class="sc">%in%</span> counties)  <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> <span class="st">`</span><span class="at">Opioids Overdose Deaths</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="fu">aes</span>(<span class="at">color =</span> County)) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="fu">aes</span>(<span class="at">color =</span> County))</span></code></pre></div>
</div>
<p>Lastly, I want to add labels and theme to really polish up our plot. This is surprisingly easy! To add our labels, we add another layer called <code>labs()</code>. Here we can add a proper title, and more accurate labels for the axes.</p>
<p>Adding a theme is even easier. We can quickly add on a layer and pick a theme that we like. For my example, I’m using the fivethirtyeight theme that comes from ggthemes. Be sure to check out the other options available in this package.</p>
<p>After our <code>theme_fivethrityeight()</code> layer, I’m adding a general <code>theme()</code> layer to specify that I want all my main title and axes titles to be shown. I am also adjusting the text size to make the title a bit more readable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>opdeaths <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(County <span class="sc">%in%</span> counties)  <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> <span class="st">`</span><span class="at">Opioids Overdose Deaths</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="fu">aes</span>(<span class="at">color =</span> County)) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="fu">aes</span>(<span class="at">color =</span> County)) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Opioid Overdose Deaths in Michigan's Capital Area </span><span class="sc">\n</span><span class="st">Counties, 1999 – 2020"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Deaths"</span>) <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fivethirtyeight</span>() <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">vjust =</span> <span class="sc">+</span><span class="dv">3</span>),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.75</span>),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Georgia"</span>),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="st">"lines"</span>))</span></code></pre></div>
</div>
<p>And just like that, we have a very nice looking line chart!</p>
<h2 id="a-glimpse-of-plotly">A Glimpse of Plotly</h2>
<p>Next I want to briefly show how easy it is to take a basic ggplot figure and make it interactive with the amazing package <code>plotly</code>. If I save the figure we created before as an object, we can pass it through the function <code>ggplotly()</code>, and as a result, we get a chart where we can zoom in and hover over points to gain more insight. I will demonstrate this below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> opdeaths <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(County <span class="sc">%in%</span> counties)  <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> <span class="st">`</span><span class="at">Opioids Overdose Deaths</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="fu">aes</span>(<span class="at">color =</span> County)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="fu">aes</span>(<span class="at">color =</span> County)) <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Opioid Overdose Deaths in Michigan's Capital Area Counties, 1999 – 2020"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Deaths"</span>) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_fivethirtyeight</span>() <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">vjust =</span> <span class="sc">+</span><span class="dv">3</span>),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.75</span>),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Georgia"</span>),</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="st">"lines"</span>))</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(p1)</span></code></pre></div>
</div>
<p>It’s amazing how quickly you can produce interactive charts with R! The output from this function in an html widget. So it can easily be viewed on a website or a local html file. This makes it ideal for sharing graphics quickly among coworkers.</p>
<p>For my project, I created a few more graphics with the same color palette and arranged them on a pdf for easy distribution. If you want to view the finished product you can find that <a href="smith-HM808-factsheet.pdf">here</a>.</p>
<p>I hope you found this post helpful. Next time I want to focus more on plotly demonstrating its capabilities with spatial data analysis. Until next time!</p>]]></content:encoded>
    </item>
  </channel>
</rss>
